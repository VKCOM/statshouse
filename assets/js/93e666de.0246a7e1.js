"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[4676],{5746:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>o,metadata:()=>h,toc:()=>l});var n=s(5893),a=s(1151);const i=s.p+"assets/images/components-order-3e8ba0791c0308a82508dec097445d21.png",o={sidebar_position:3,title:"Install components"},r="Install components",h={id:"admin/install",title:"Install components",description:"Here is the flow to install StatsHouse components (1 \u2192 5):",source:"@site/docs/admin/install.md",sourceDirName:"admin",slug:"/admin/install",permalink:"/statshouse/admin/install",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3,title:"Install components"},sidebar:"tutorialSidebar",previous:{title:"Find packages",permalink:"/statshouse/admin/packages"},next:{title:"Monitor StatsHouse",permalink:"/statshouse/admin/monitor"}},c={},l=[{value:"ClickHouse database",id:"clickhouse-database",level:2},{value:"Cluster scheme",id:"cluster-scheme",level:3},{value:"Cluster configuration (storage policies)",id:"cluster-configuration-storage-policies",level:3},{value:"Metadata service",id:"metadata-service",level:2},{value:"In case of metadata service failure",id:"in-case-of-metadata-service-failure",level:3},{value:"Aggregators",id:"aggregators",level:2},{value:"Agents",id:"agents",level:2},{value:"How to monitor the agent&#39;s health",id:"how-to-monitor-the-agents-health",level:3},{value:"API/UI",id:"apiui",level:2},{value:"Authentication",id:"authentication",level:3},{value:"Ingress proxy",id:"ingress-proxy",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"install-components",children:"Install components"}),"\n",(0,n.jsx)(t.p,{children:"Here is the flow to install StatsHouse components (1 \u2192 5):"}),"\n",(0,n.jsx)("img",{src:i,width:"500"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"/statshouse/quick-start",children:"local StatsHouse installation"})," is almost the same. The only difference is that\nthe ",(0,n.jsx)(t.a,{href:"https://github.com/VKCOM/statshouse/blob/master/localrun.sh",children:"local installation script"})," puts the ClickHouse\ndatabase and aggregator on different virtual machines. To install StatsHouse on the real servers, use the same\nmachine for the ClickHouse database and the aggregator."]}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components",children:"components"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"clickhouse-database",children:"ClickHouse database"}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#database",children:"database"})," component in the conceptual overview."]}),"\n",(0,n.jsxs)(t.p,{children:["Check the ",(0,n.jsx)(t.a,{href:"/statshouse/admin/sys-req",children:"system requirements for the ClickHouse machines"}),".\nWe recommend using fast SSDs for storing per-second data, so that StatsHouse is able to provide you with the live mode.\nSee more about the ClickHouse ",(0,n.jsx)(t.a,{href:"#cluster-configuration-storage-policies",children:"configuration (storage policies)"}),"."]}),"\n",(0,n.jsx)(t.h3,{id:"cluster-scheme",children:"Cluster scheme"}),"\n",(0,n.jsx)(t.p,{children:"The ClickHouse cluster must have three replicas per shard. You can have any number of shards (one or more)."}),"\n",(0,n.jsxs)(t.p,{children:["Find the ",(0,n.jsx)(t.a,{href:"https://github.com/VKCOM/statshouse/blob/master/build/clickhouse-cluster.sql",children:"scheme"}),"\nto create the necessary ClickHouse tables."]}),"\n",(0,n.jsx)(t.h3,{id:"cluster-configuration-storage-policies",children:"Cluster configuration (storage policies)"}),"\n",(0,n.jsx)(t.p,{children:"Find the example of the ClickHouse cluster configuration:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"<storage_configuration>\n<disks>\n  <clickhouse_fast>\n    <path>/var/lib/clickhouse-fast/</path>\n  </clickhouse_fast>\n</disks>\n<policies>\n  <ssd_then_hdd>\n    <volumes>\n      <ssd>\n        <disk>clickhouse_fast</disk>\n      </ssd>\n      <hdd>\n        <disk>default</disk>\n      </hdd>\n    </volumes>\n  </ssd_then_hdd>\n</policies>\n</storage_configuration>\n"})}),"\n",(0,n.jsx)(t.p,{children:"This policy means that ClickHouse should initially insert data into the fast SSDs, and then move it to the slower\nHDDs."}),"\n",(0,n.jsxs)(t.p,{children:["This configuration is applied to a created table:\nsee the above-mentioned ",(0,n.jsx)(t.a,{href:"https://github.com/VKCOM/statshouse/blob/master/build/clickhouse-cluster.sql",children:"scheme"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"metadata-service",children:"Metadata service"}),"\n",(0,n.jsx)(t.p,{children:"As soon as you have created the ClickHouse tables, proceed to metadata service installation."}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#metadata",children:"metadata"})," component in the conceptual\noverview."]}),"\n",(0,n.jsx)(t.p,{children:"You may install the metadata service on any machine. You have one metadata service instance."}),"\n",(0,n.jsxs)(t.p,{children:["To handle the possible failure of the metadata service, back up it manually. Now, one can copy the\ndatabase binlog once a day using the ",(0,n.jsx)(t.code,{children:"cron"})," job to restart the service if necessary."]}),"\n",(0,n.jsx)(t.admonition,{type:"info",children:(0,n.jsx)(t.p,{children:"We are now developing our own consensus mechanism to make the metadata service distributed."})}),"\n",(0,n.jsx)(t.p,{children:"The metadata service needs the following parameters:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--db-path"})," that is the place to store data;"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--binlog-prefix"})," that is the place to store the binlog."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Find the example of the metadata service installation script:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"statshouse-metadata --db-path=/var/lib/statshouse/metadata/db --binlog-prefix=/var/lib/statshouse/metadata/binlog/bl\n"})}),"\n",(0,n.jsx)(t.p,{children:"The aggregator, the API/UI component, and the agents need to know the metadata address. The agents get this\ninformation from the aggregators."}),"\n",(0,n.jsx)(t.p,{children:"The metadata service has its agent too."}),"\n",(0,n.jsx)(t.h3,{id:"in-case-of-metadata-service-failure",children:"In case of metadata service failure"}),"\n",(0,n.jsxs)(t.p,{children:["If the metadata service is unreachable, StatsHouse cannot create new metrics and tags, and use tag information (see\nmore about the ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#metadata",children:"mapping mechanism"}),")."]}),"\n",(0,n.jsx)(t.p,{children:"Each StatsHouse component has its metadata copy and continues working even in case of metadata failure.\nBut if the component fails too, it will not be able to restore."}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsx)(t.p,{children:"In case of aggregator failure, restore the metadata service with the same IP address as soon as possible."})}),"\n",(0,n.jsx)(t.h2,{id:"aggregators",children:"Aggregators"}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#aggregator",children:"aggregator"})," component in the\nconceptual overview."]}),"\n",(0,n.jsx)(t.p,{children:"The aggregator needs to know where to find the cluster, so please specify the following parameters:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--cluster"})," that is the cluster name,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--kh"})," that is the database address (the database may contain many clusters),"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--agg-addr"})," that is the port to listen to,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--aes-pwd-file"})," that is the directory with the encryption key (the obligatory start parameter: ",(0,n.jsx)(t.code,{children:"/etc/engine/pass"}),"\nby default),"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--cache-dir"})," that is the directory to store data in case the database does not insert data,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"-u"}),", ",(0,n.jsx)(t.code,{children:"-g"})," that are the group and the user (the obligatory start parameters)."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"On each ClickHouse replica, install the StatsHouse aggregator. Find the example of the aggregator installation script:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"statshouse aggregator --cluster=test_shard_localhost --agg-addr=':13336' --aes-pwd-file=/etc/engine/pass \\\n--kh=XXX.X.X.X:XXXX --cache-dir=/var/lib/statshouse/cache/aggregator -u=root -g=root\n"})}),"\n",(0,n.jsx)(t.p,{children:"As the aggregators get the ClickHouse cluster address, they get info about the shard and the replica they are\ninstalled on."}),"\n",(0,n.jsx)(t.p,{children:"The agents need all the aggregators' addresses. Each agent scans these addresses successively and tries to get the\nnecessary configuration from the first available one.\nThe agent sends the data to the aggregators in a pseudorandom order."}),"\n",(0,n.jsxs)(t.p,{children:["The aggregator starts with the ",(0,n.jsx)(t.code,{children:"--aes-pwd-file"})," parameter that is the directory containing a key to decrypt the\nincoming traffic. Read more about the ",(0,n.jsx)(t.code,{children:"--aes-pwd-file"})," parameter and the encryption keys in the\n",(0,n.jsx)(t.a,{href:"/statshouse/admin/security",children:"security"})," section."]}),"\n",(0,n.jsxs)(t.p,{children:["The size of the ",(0,n.jsx)(t.code,{children:"--cache-dir"})," directory should be enough to store data resulting from ",(0,n.jsx)(t.strong,{children:"six hours"})," of the aggregator\nworking."]}),"\n",(0,n.jsx)(t.h2,{id:"agents",children:"Agents"}),"\n",(0,n.jsxs)(t.admonition,{type:"important",children:[(0,n.jsx)(t.p,{children:"Make sure an agent is installed on each machine that sends metrics to StatsHouse:"}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"the ClickHouse/aggregators' machines,"}),"\n",(0,n.jsx)(t.li,{children:"the metadata service machine,"}),"\n",(0,n.jsx)(t.li,{children:"the API/UI ocmponent machine."}),"\n"]})]}),"\n",(0,n.jsx)(t.p,{children:"The agent opens the local port (13337, by default) and gets data from the application. Then it sends the data to the\naggregators."}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#agent",children:"agent"})," component in the conceptual overview."]}),"\n",(0,n.jsx)(t.p,{children:"The agents are available as the RPM or DEB packages, for example:"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"statshouse-2024.05.1-1.almalinux9.x86_64.rpm"})," or ",(0,n.jsx)(t.code,{children:"statshouse_2024.05.1-focal_amd64.deb"}),"."]}),"\n",(0,n.jsx)(t.p,{children:"The agent needs the following parameters:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--agg-addr"})," that is the aggregators' (or the proxies') addresses,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--aes-pwd-file"})," that is the directory with the encryption key (encrypting the data the agent sends to the aggregator\nor the ingress proxy),"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--cache-dir"})," that is the directory to store data in case the aggregator is unavailable,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--env-file-path"})," (optional) that is the file to configure tags for the host (hardware) metrics."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Find the example of the agent installation script:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"statshouse agent --agg-addr=XX.XXX.XXX.XXX:XXXX,YY.YYY.YYY.YYY:YYYY,ZZ.ZZZ.ZZZ.ZZZ:ZZZZ \\ \n--aes-pwd-file=/etc/engine/pass --cache-dir=/var/lib/statshouse/\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The size of the ",(0,n.jsx)(t.code,{children:"--cache-dir"})," directory should be enough to store data resulting from ",(0,n.jsx)(t.strong,{children:"six hours"})," of the agent working.\nIf the aggregators are unavailable for more than six hours, the older data is deleted from the disk."]}),"\n",(0,n.jsxs)(t.p,{children:["Read more about the ",(0,n.jsx)(t.code,{children:"--aes-pwd-file"})," parameter and the encryption keys in the ",(0,n.jsx)(t.a,{href:"/statshouse/admin/security",children:"security"})," section."]}),"\n",(0,n.jsxs)(t.p,{children:["Read more about ",(0,n.jsx)(t.a,{href:"/statshouse/admin/host-metrics#how-to-use-tags-for-the-hardware-host-metrics",children:"using tags for the host (hardware) metrics"}),"\nand the ",(0,n.jsx)(t.code,{children:"--env-file-path"})," parameter."]}),"\n",(0,n.jsx)(t.h3,{id:"how-to-monitor-the-agents-health",children:"How to monitor the agent's health"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["Open the ",(0,n.jsx)(t.code,{children:"__heartbeat_version"})," ",(0,n.jsx)(t.a,{href:"/statshouse/admin/monitor#service-metrics",children:"service metric"})," that shows the number of running\ncomponents."]}),"\n",(0,n.jsxs)(t.li,{children:["For the ",(0,n.jsx)(t.code,{children:"component"})," tag, select the ",(0,n.jsx)(t.code,{children:"agent"})," tag value."]}),"\n",(0,n.jsxs)(t.li,{children:["For the ",(0,n.jsx)(t.code,{children:"host"})," tag, select the required hostname."]}),"\n",(0,n.jsx)(t.li,{children:"Check if you see the heartbeat from the host."}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["Additionally, check if the agent is able to send real metric data:\n",(0,n.jsx)(t.a,{href:"/statshouse/guides/send-data#how-to-send-data-without-client-libraries",children:"send a testing piece of data from the host"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"apiui",children:"API/UI"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#application-programming-interface-api",children:"API component"})," has the StatsHouse\nuser interface as its part. As soon as you start the API/UI component, you can view\nthe ",(0,n.jsx)(t.a,{href:"/statshouse/guides/view-graph#service-metrics",children:"service metrics"})," that help to monitor StatsHouse."]}),"\n",(0,n.jsx)(t.p,{children:"You can install the API component on any machine."}),"\n",(0,n.jsx)(t.p,{children:"The API component needs the following parameters:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--clickhouse-v2-addrs"})," that is the ClickHouse cluster address,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--listen-addr"})," that is the port to listen to,"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--disk-cache"})," that is the place to store the cached\n",(0,n.jsxs)(t.a,{href:"/statshouse/overview/components#the-budget-for-creating-tag-values",children:["global ",(0,n.jsx)(t.code,{children:"string\u2194int32"})," map"]}),","]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.code,{children:"--static-dir"})," that is the place where the UI static files live."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Find the example of the API/UI installation script:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"statshouse-api --clickhouse-v2-addrs=XXX.X.X.X:XXXX \\\n--listen-addr=:YYYYY --disk-cache=/var/lib/statshouse/cache/api/mapping_cache.sqlite3 \\\n--static-dir=/usr/lib/statshouse-api/statshouse-ui/\n"})}),"\n",(0,n.jsx)(t.h3,{id:"authentication",children:"Authentication"}),"\n",(0,n.jsxs)(t.p,{children:["You may use an authentication mechanism you need, for example, an ",(0,n.jsx)(t.em,{children:"nginx"})," server using JSON Web Tokens (JWT)."]}),"\n",(0,n.jsxs)(t.p,{children:["To use the API with no authentication, enable the ",(0,n.jsx)(t.code,{children:"--insecure-mode"})," option."]}),"\n",(0,n.jsx)(t.h2,{id:"ingress-proxy",children:"Ingress proxy"}),"\n",(0,n.jsxs)(t.p,{children:["Find information about the StatsHouse ",(0,n.jsx)(t.a,{href:"/statshouse/overview/components#ingress-proxy",children:"ingress proxy"})," component in\nthe conceptual overview. Read more about ",(0,n.jsx)(t.a,{href:"/statshouse/admin/security",children:"ensuring security"}),"\nwith the ingress proxies and the cryptokeys."]})]})}function u(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,t,s)=>{s.d(t,{Z:()=>r,a:()=>o});var n=s(7294);const a={},i=n.createContext(a);function o(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);