<!doctype html>
<html lang="en-US" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-overview/components" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Components | StatsHouse</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://github.com/statshouse/overview/components"><meta data-rh="true" property="og:locale" content="en_US"><meta data-rh="true" property="og:locale:alternate" content="ru_RU"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Components | StatsHouse"><meta data-rh="true" name="description" content="Find basic StatsHouse components in the picture:"><meta data-rh="true" property="og:description" content="Find basic StatsHouse components in the picture:"><link data-rh="true" rel="icon" href="/statshouse/img/statshouse.ico"><link data-rh="true" rel="canonical" href="https://github.com/statshouse/overview/components"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/overview/components" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/ru/overview/components" hreflang="ru-RU"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/overview/components" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/statshouse/blog/rss.xml" title="StatsHouse RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/statshouse/blog/atom.xml" title="StatsHouse Atom Feed">



<link rel="preconnect" href="https://mc.yandex.ru">
<script>!function(e,t,a,c,n,r,i){e[n]=e[n]||function(){(e[n].a=e[n].a||[]).push(arguments)},e[n].l=1*new Date,r=t.createElement(a),i=t.getElementsByTagName(a)[0],r.async=1,r.src="https://mc.yandex.ru/metrika/tag.js",i.parentNode.insertBefore(r,i)}(window,document,"script",0,"ym"),ym(96098475,"init",{defer:!0,clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0,ecommerce:!1,trackHash:!1})</script>
<noscript>
                            <div><img src="https://mc.yandex.ru/watch/96098475" style="position:absolute; left:-9999px;" alt=""></div>
                        </noscript><link rel="stylesheet" href="/statshouse/assets/css/styles.8b14ad53.css">
<script src="/statshouse/assets/js/runtime~main.d65b5a5e.js" defer="defer"></script>
<script src="/statshouse/assets/js/main.d0f988b1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/statshouse/"><div class="navbar__logo"><img src="/statshouse/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/statshouse/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">StatsHouse Docs</b></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div><a class="navbar__item navbar__link" href="/statshouse/blog">What&#x27;s new</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/statshouse/overview/components" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-US">English</a></li><li><a href="/statshouse/ru/overview/components" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="ru-RU">Русский</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/VKCOM/statshouse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/">What is StatsHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/tldr">TLDR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/quick-start">Quick start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/statshouse/guides/access-cluster">User guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/statshouse/admin/sys-req">Administrator guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/statshouse/overview/features">Overview</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/overview/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/overview/concepts">Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/statshouse/overview/components">Components</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/support">Support</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/statshouse/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Overview</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Components</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Components</h1>
<p>Find basic StatsHouse components in the picture:</p>
<img src="/statshouse/assets/images/components-91a7e70e1abfb6ae828f099df6ad4d49.png" width="1000">
<p>Check the descriptions below:</p>
<ul>
<li><a href="#agent">Agent</a>
<ul>
<li><a href="#receiving-data-via-udp">Receiving data via UDP</a></li>
<li><a href="#deploying-agents-in-the-kubernetes-pods">Deploying agents in the Kubernetes pods</a></li>
</ul>
</li>
<li><a href="#aggregator">Aggregator</a>
<ul>
<li><a href="#real-time-and-historical-data">Real-time and &quot;historical&quot; data</a></li>
<li><a href="#handling-aggregators-shutdown">Handling aggregator&#x27;s shutdown</a></li>
</ul>
</li>
<li><a href="#database">Database</a></li>
<li><a href="#application-programming-interface-api">Application programming interface (API)</a></li>
<li><a href="#user-interface-ui">User interface (UI)</a></li>
<li><a href="#ingress-proxy">Ingress proxy</a></li>
<li><a href="#metadata">Metadata</a>
<ul>
<li><a href="#the-budget-for-creating-tag-values">The budget for creating tag values</a>
<ul>
<li><a href="#string-top-tag"><em>String top</em> tag</a></li>
<li><a href="#raw-tags"><em>Raw</em> tags</a></li>
</ul>
</li>
<li><a href="#the-budget-for-creating-metrics">The budget for creating metrics</a></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agent">Agent<a href="#agent" class="hash-link" aria-label="Direct link to Agent" title="Direct link to Agent">​</a></h2>
<p>The agent</p>
<ul>
<li>validates metric data (e.g., if a metric exists),</li>
<li><a href="/statshouse/overview/concepts#aggregation">aggregates</a> data over a second,</li>
<li>determines how to shard data,</li>
<li>and sends data to aggregators.</li>
</ul>
<img src="/statshouse/assets/images/agent-2b52ee89860a5ea30deee612bc707b4a.png" width="500">
<p>If aggregators are unavailable, the agent stores data on a local disk within the quota and sends it later.</p>
<p>An agent receives metric data via <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank" rel="noopener noreferrer">UDP</a>. Supported formats are</p>
<ul>
<li><a href="https://www.json.org/json-en.html" target="_blank" rel="noopener noreferrer">JSON</a>,</li>
<li><a href="https://protobuf.dev" target="_blank" rel="noopener noreferrer">Protocol Buffers</a>,</li>
<li><a href="https://msgpack.org" target="_blank" rel="noopener noreferrer">MessagePack</a>,</li>
<li><a href="https://core.telegram.org/mtproto/TL" target="_blank" rel="noopener noreferrer">TL</a>.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Agents support IPv6.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="receiving-data-via-udp">Receiving data via UDP<a href="#receiving-data-via-udp" class="hash-link" aria-label="Direct link to Receiving data via UDP" title="Direct link to Receiving data via UDP">​</a></h3>
<p>StatsHouse receives data via UDP in the MessagePack, Protocol Buffers, JSON, and TL formats—they are semantically
identical. It automatically detects the format by the first bytes in the packet.</p>
<p>Find the schemes for <a href="https://github.com/VKCOM/statshouse/blob/master/internal/data_model/public.tl" target="_blank" rel="noopener noreferrer">TL</a>, MessagePack,
and <a href="https://github.com/VKCOM/statshouse/blob/master/internal/receiver/statshouse.proto" target="_blank" rel="noopener noreferrer">Protocol Buffers</a>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">TL</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">MessagePack</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Protocol Buffers</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">---types---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statshouse.metric#3325d884 fields_mask:#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name:    string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags:    (dictionary string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">counter: fields_mask.0?double</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ts:      fields_mask.4?#               // UNIX timestamp UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value:   fields_mask.1?(vector double)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique:  fields_mask.2?(vector long)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">= statshouse.Metric;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---functions---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth JSON interoperability, first byte of tag must not be 0x5b or 0x7b (&quot;[&quot; or &quot;{&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth MessagePack interoperability, first byte of tag must be less than 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth ProtoBuf interoperability, first byte must be as large as possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@write statshouse.addMetricsBatch#56580239 fields_mask:# metrics:(vector statshouse.metric) = True;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-{ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  metrics: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ts:   1670673392,     # uint32, UNIX timestamp in seconds (optional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: &quot;foobar&quot;,       # string([a-zA-Z][a-zA-Z0-9_]*), metric name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tags: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;env&quot;:              # string([a-zA-Z][a-zA-Z0-9_]*), tag name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;production&quot;      # string(printable UTF-8),       tag value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      counter: 100500.1,    # float64,        number of observed events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value:   [0.7],       # array(float64), observed values array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unique:  [591068825], # array(int64),   observed IDs array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package statshouse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option go_package = &quot;github.com/vkcom/statshouse/internal/receiver/pb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message Metric {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string              name    = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; tags    = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double              counter = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint32              ts      = 4;  // UNIX seconds UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated double     value   = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated int64      unique  = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message MetricBatch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated Metric metrics = 13337;  // to autodetect packet format by first bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// to compile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// sudo apt-get install libprotobuf-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// go install google.golang.org/protobuf/cmd/protoc-gen-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ~/go/src/github.com/vkcom/statshouse$ protoc -I=internal/receiver --go_out=../../../../.. statshouse.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// to compile if proto3 format not supported, for example by protocute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. comment out line: option go_package = &quot;github.com/vkcom/statshouse/internal/receiver/pb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// message MapFieldEntry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   optional string key = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   optional string value = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. replace Metric with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// message Metric {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// string              name    = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// map&lt;string, string&gt; tags    = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// double              counter = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// uint32              ts      = 4;  // UNIX seconds UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// repeated double     value   = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// repeated int64      unique  = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. ./protocute --cpp_out=. ~/go/src/github.com/vkcom/statshouse/internal/receiver/statshouse.proto</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>A packet is an object with an array of metrics inside:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;metrics&quot;:[ ... ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Each element in this array is an object with the fields:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;name&quot;:&quot;rpc_call_latency&quot;,  // metric name (obligatory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;tcp&quot;}, // tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;ts&quot;: 1630000000,           // timestamp; 0 and no timestamp means &quot;now&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 6,               // event counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;value&quot;: [1, 2.0, -3.0],    // values if any (do not use with &quot;unique&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;unique&quot;: [15, 18, -60]     // unique counters if any (do not use with &quot;value&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For example, one can send a packet like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;:&quot;rpc_call_latency&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;tcp&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;value&quot;: [15, 18, 60]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;: &quot;rpc_call_errors&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;udp&quot;,&quot;error_code&quot;: &quot;-3000&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 5}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;: &quot;external_landings&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;country&quot;: &quot;ru&quot;,&quot;gender&quot;: &quot;m&quot;,&quot;skey&quot;: &quot;lenta.ru&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Сheck the requirements for using formats.</p>
<ul>
<li>For TL: the packet body should be the Boxed-serialized <code>statshouse.addMetricsBatch</code> object.</li>
<li>For JSON: the first character should be a curly bracket <code>{</code> (to detect the format correctly).</li>
<li>For Protocol Buffers: do not add fields to the <code>MetricBatch</code> object (to detect the format correctly).</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="deploying-agents-in-the-kubernetes-pods">Deploying agents in the Kubernetes pods<a href="#deploying-agents-in-the-kubernetes-pods" class="hash-link" aria-label="Direct link to Deploying agents in the Kubernetes pods" title="Direct link to Deploying agents in the Kubernetes pods">​</a></h3>
<p>Please avoid deploying agents in the Kubernetes pods.
We strongly recommend deploying them on the real servers—make sure to specify the <code>13337</code> port.</p>
<p>The number of agents should not be fluctuating.
The agents send per-second reports to the aggregators. The permanent number of agents indicates that the agents are
connected to the aggregators. The pods that stopped working reduce the number of agents and activate the main StatsHouse alert.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p>With the VK RPC protocol, StatsHouse gets the ephemeral connection keys using the remote and local IP addresses
of the connection—as they are shown to the client and the server.
Routing packets from one adapter to another via firewall makes establishing the connections impossible.
To connect the Kubernetes-like components, create the virtual network adapters and connect
them using the Linux network namespaces.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="aggregator">Aggregator<a href="#aggregator" class="hash-link" aria-label="Direct link to Aggregator" title="Direct link to Aggregator">​</a></h2>
<p>It aggregates per-second metric data from all the agents and inserts the resulting aggregation into the ClickHouse
database.</p>
<img src="/statshouse/assets/images/aggregator-a14cccc8b6f4553a710273af7dc5abde.png" width="500">
<p>There are as many aggregators as there are ClickHouse shards with replicas. Each aggregator inserts data to its
local database replica deployed on the same machine. For example: 3 shards × 3 replicas = 9 aggregators.</p>
<img src="/statshouse/assets/images/shards-replicas-475e10fbe68f8cda26316cb0ede8076d.png" width="700">
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="real-time-and-historical-data">Real-time and &quot;historical&quot; data<a href="#real-time-and-historical-data" class="hash-link" aria-label="Direct link to Real-time and &quot;historical&quot; data" title="Direct link to Real-time and &quot;historical&quot; data">​</a></h3>
<p>The aggregator has two &quot;workflows&quot;:</p>
<ul>
<li>for real-time data,</li>
<li>for &quot;historical&quot; data. The data is &quot;historical&quot; if it has not been sent immediately upon creating.</li>
</ul>
<p>Inserting real-time data is the top priority for the aggregator.</p>
<img src="/statshouse/assets/images/real-hist-bc7cebbb031517a8477b2c88aa11865a.png" width="800">
<p>Imagine the breakdown situation: it was impossible to insert data for a long time, then the system recovered.
StatsHouse starts to insert real-time data immediately. As for the &quot;historical&quot; data, StatsHouse will insert it as
soon as possible—if only it does not prevent real-time data from being inserted.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p>Prioritizing real-time data in StatsHouse is related to the ClickHouse database&#x27;s way of inserting &quot;historical&quot; data,
which is rather slow.</p><p><strong>Real-time data</strong></p><p>The aggregator allows agents to insert last 5-minute data—this is a &quot;small&quot; inserting window (customizable).
If an agent was not able to insert data in time, it is required to send data as the &quot;historical&quot; one.</p><p>The aggregator keeps a container with statistics per each second—such a container aggregates data from the agents.
As soon as the next second data arrives, the aggregator inserts this data (from the &quot;small&quot; window) into the database.
And the agents receive the response with the insert result.</p><p>The &quot;small&quot; window extends to the future for 2 seconds. It helps the agents to insert data correctly
if their clock is going too fast.</p><p><strong>&quot;Historical&quot; data</strong></p><p>The aggregator allows agents to insert last 48-hour data—this is a &quot;large&quot; inserting window (customizable).</p><p>If the data is older than 48 hours, StatsHouse records meta-statistics, and throws away this piece of data. The agent
receives the <code>OK</code> response.</p><p>The between-host aggregation is really important, so StatsHouse does its best to make it possible:
</p><li>each agent makes a request to insert a few tens of &quot;historical&quot; seconds—starting from the &quot;oldest&quot; one;</li>
<li>the aggregator receives these requests and chooses the &quot;oldest&quot; second;</li>
<li>it aggregates data, inserts it into the database and sends the response;</li>
<li>then it chooses the &quot;oldest&quot; second again, etc.</li><p></p><p>This algorithm helps the most distant (&quot;oldest&quot;) seconds to come up with the &quot;newest&quot; ones. It makes aggregating
historical data possible and helps to insert data simultaneously.</p></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-aggregators-shutdown">Handling aggregator&#x27;s shutdown<a href="#handling-aggregators-shutdown" class="hash-link" aria-label="Direct link to Handling aggregator&#x27;s shutdown" title="Direct link to Handling aggregator&#x27;s shutdown">​</a></h3>
<p>If the aggregator is unavailable or responds with an error, the agent stores data on a local disk.
Storing data on a disk is limited in bytes. It is also limited in time—within the &quot;large&quot;
(48-hour) inserting window.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p><strong>Distributing data between the replicas</strong></p><p>If it is unacceptable or impossible to access the disk, one may run the agent with the empty <code>--cache-dir</code> argument.
StatsHouse will not use the disk. The &quot;historical&quot; data will be stored in memory—while the aggregators are
unavailable, i.e., for several minutes.</p><p>If the aggregator is unavailable, the agents send data to the rest of the replicas.
The data is distributed according to the seconds&#x27; ordinal numbers: the even seconds are sent to one of the replicas,
the odd seconds are sent to another. So the load for both increases by 50%. This is one of the reasons to support
writing data to exactly three ClickHouse replicas.</p><p><strong>Handling double inserts</strong></p><p>If the aggregator responds with an error, the agent sends data to another aggregator (another replica) on the other
host. For deduplication, we need a consensus algorithm, which is a rather complicated thing.</p><p>In StatsHouse, the main and the back-up aggregators can insert data from the same agent at the same second.
For this rare case, we track the double inserts via the <code>__heartbeat_version</code> meta-metric, which is the <em>number of
agents sending data at the current second</em>. To make this meta-metric stable during normal aggregators&#x27; operation,
the agents send data every second—even if there is no real user data at the moment.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="database">Database<a href="#database" class="hash-link" aria-label="Direct link to Database" title="Direct link to Database">​</a></h2>
<p>The <a href="https://clickhouse.com" target="_blank" rel="noopener noreferrer">ClickHouse</a> database stores <a href="/statshouse/overview/concepts#aggregation">aggregated</a> metric data.</p>
<p>StatsHouse inserts metric data into the ClickHouse table having the following definition:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE statshouse2_value_1s (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `time`           DateTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `metric`         Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag0`           Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag1`           Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag15`          Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `stag`           String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `count`          SimpleAggregateFunction(sum, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `min`            SimpleAggregateFunction(min, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `max`            SimpleAggregateFunction(max, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `sum`            SimpleAggregateFunction(sum, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `max_host`       AggregateFunction(argMax, Int32, Float32), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `percentiles`    AggregateFunction(quantilesTDigest(0.5), Float32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `uniq_state`     AggregateFunction(uniq, Int64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = *MergeTree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY toDate(time) ORDER BY (metric, time,tag0,tag1, ...,tag15, stag);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If writing <a href="/statshouse/guides/edit-metrics#percentiles">percentiles</a> is not enabled for a metric, or the metric is not a
<a href="/statshouse/guides/design-metric#unique-counters"><em>unique counter</em></a>, the corresponding table columns (<code>percentiles</code> or <code>uniq_state</code>) are empty.</p>
<p>If a metric is a simple <a href="/statshouse/guides/design-metric#counters">counter</a>, all the columns are empty except the <code>count</code>
one.  The <code>stag</code> column is not empty only if a metric has a <a href="/statshouse/guides/design-metric#string-top-tag">String top tag</a>.</p>
<p>To get data for time intervals longer than a second, StatsHouse aggregates data within them and produces per-minute
and per-hour aggregates.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p>Data is distributed across the ClickHouse shards using the hash of <code>metric, key0, … , key15</code>.
If a metric has multiple tags, its data related to a particular tag (i.e., <code>&quot;protocol&quot;:&quot;tcp&quot;</code>) are usually stored on
different shards. To get the full statistics, one should always make <em>distributed queries</em> to the whole set of shards.</p><p>What is the reason for it?
The set of tag values has a certain cardinality: there is a finite number of possible tag value combinations for a
metric. If we reach this cardinality limit, i.e., we send all these tag value combinations, the amount of data stops
increasing due to aggregation—StatsHouse aggregates the events with the same tag value combination.</p><p>To store the sample of data for the whole metric, each shard should store as many rows as there are tag value
combinations for a metric—not a part proportional to a number of shards.</p><p>StatsHouse does not use buffer tables—each aggregator inserts data once per second. Data is inserted into the
incoming table. The data is filtered by <code>time</code> within a receive window (48 hours) and copied via the meterialized
view. It prevents StatsHouse from inserting the &quot;garbage&quot; data. Otherwise, ClickHouse should have read data not
from one or two partitions but from all of them.</p><p>A shard should have three or more replicas. Aggregators insert data into the first three replicas.
The rest ones are read-only replicas and may be used to scale the reading load.</p><p>The number of shards can be any. To prevent incorrect configuration and inconsistent sharding, which may lead to a
sharp increase in the amount of data due to weak aggregation, agents send the number of a replica shard to
the aggregator. If the aggregator is not the right recipient for this data, it responds with an error. The same
number helps the <em>ingress proxy</em> to forward data to the right aggregator.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application-programming-interface-api">Application programming interface (API)<a href="#application-programming-interface-api" class="hash-link" aria-label="Direct link to Application programming interface (API)" title="Direct link to Application programming interface (API)">​</a></h2>
<p>Find StatsHouse <a href="/statshouse/guides/openapi">OpenAPI</a> specification.</p>
<p>The thin API client allows StatsHouse to send efficient queries to the database.
The service caches data to minimize a database load. We limit retrieving data directly from ClickHouse
as much as possible, since ineffective queries can negatively impact the ClickHouse cluster.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="user-interface-ui">User interface (UI)<a href="#user-interface-ui" class="hash-link" aria-label="Direct link to User interface (UI)" title="Direct link to User interface (UI)">​</a></h2>
<p>A user interface retrieves data from the StatsHouse API and displays metric data in a graph view.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ingress-proxy">Ingress proxy<a href="#ingress-proxy" class="hash-link" aria-label="Direct link to Ingress proxy" title="Direct link to Ingress proxy">​</a></h2>
<p>An ingress proxy receives data from the agents that live outside the protected perimeter
(i.e., outside the data center) and sends it to the aggregators.</p>
<p>Agents and aggregators use the TL/RPC protocol with the data center encryption key. So, the agents outside the
data center cannot connect to aggregators directly, because it would require disclosing or copying the key to the
external systems.</p>
<p>The ingress proxy has a separate set of encryption keys for the external connections. To revoke the encryption
key, one should delete it from the ingress proxy configuration.</p>
<p>Ingress proxy does not have a state. To reduce the likelihood of an attack, it proxies only the subset of TL/RPC
request types used by the aggregators.</p>
<p>There should be exactly three ingress proxies. Each of them is a proxy to a corresponding replica of a shard.
If the proxy is unavailable due to service or shutdown, it is equivalent to a breakdown of one shard&#x27;s replica and
does not affect the normal operation of the StatsHouse system.</p>
<img src="/statshouse/assets/images/ingress-proxy-84f922c34ded3524048637ae15c26af5.png" width="600">
<p>Three ingress proxy instances simulate aggregators. One can set up one more ingress proxy level behind the existing
proxies. This level will use the previous ingress proxies as the aggregators.</p>
<p>Please avoid deploying ingress proxies in the Kubernetes pods.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p><strong>Cryptokeys</strong></p><p>StatsHouse uses the VK RPC protocol with the (optional) encryption to connect the components.</p><p>According to the VK RPC protocol, the cryptokey is both the login for getting access and the secret for getting the
ephemeral connection keys. To establish a connection, the client has to use one of the keys known to a server.
The central system component is the aggregators. Upon startup, they get the single &quot;major&quot; data center cryptokey.</p><p>To connect to aggregators, the agents should get the parameters:
</p><li><code>-agg-addr</code>—the addresses of the first aggregators&#x27; shards;</li>
<li><code>-aes-pwd-file</code>—the &quot;major&quot; data center cryptokey.</li><p></p><p>The mechanism above is secure only inside the protected perimeter. To connect from the outside, use the ingress proxy
installed at the border.</p><p>This ingress proxy at the border has two parts:
</p><li>an RPC server for the agents to connect from the outside,</li>
<li>an RPC client for the proxy to connect to the aggregators within the perimeter.</li><p></p><p>For the ingress proxy, one should configure the parameters:
</p><li><code>-ingress-external-addr</code>—the proxies&#x27; external addresses the agents use for connection;</li>
<li><code>-ingress-addr</code>—the parameter to control the interfaces for connecting agents.</li>
<li><code>-aes-pwd-file</code>—the inner cryptokey for sending data to the aggregators,</li>
<li><code>-ingress-pwd-dir</code>—a set of the external keys for the agents from the remote sites.</li><p></p><p>The <code>-ingress-addr</code> parameter is usually <code>:8128</code> that is the same as <code>0.0.0.0:8128</code>.
It also may contain the subnet address of the network adapter to make it the
only gateway for connections. The port in the <code>-ingress-addr</code> parameter should match one of the ports in the
<code>-ingress-external-addr</code> parameter. The &quot;outer&quot; part of the ingress proxy should be available to the agents via
these ports.</p><p>Each of these files contains the cryptokey; the file name is ignored and regarded as a comment.<br>
<!-- -->The keys have random length—four bytes at least. The first four bytes are for key identification, so they must not
be identical.</p><p>If the external keys in the directory are changed, restart the ingress proxy. The ingress proxy does not keep track
of this directory, because the external keys in the set are changed rarely.</p><p>Each agent gets one of the keys from the ingress proxy&#x27;s <code>-ingress-pwd-dir</code> directory as the <code>-aes-pwd-file</code>
parameter.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="metadata">Metadata<a href="#metadata" class="hash-link" aria-label="Direct link to Metadata" title="Direct link to Metadata">​</a></h2>
<p>The metadata component stores the global <code>string</code>↔<code>int32</code> map—it maps the metric names and
the tag values, which are strings, to integers.</p>
<p>StatsHouse is known for providing real-time data. To provide users with low latency, StatsHouse maps the
<code>string</code> tag values (as well as metric names) to <code>int32</code> values:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;iphone&#x27; &lt;=&gt; 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;null&#x27; &lt;=&gt; 26</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This huge <code>string</code>↔<code>int32</code> map is common for all metrics. The elements of this map are never deleted.</p>
<p>To prevent the uncontrollable increase of the <code>string</code>↔<code>int32</code> map, the budgets for
<a href="#the-budget-for-creating-metrics">creating metrics</a> and <a href="#the-budget-for-creating-tag-values">tag values</a> are limited.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-budget-for-creating-tag-values">The budget for creating tag values<a href="#the-budget-for-creating-tag-values" class="hash-link" aria-label="Direct link to The budget for creating tag values" title="Direct link to The budget for creating tag values">​</a></h3>
<p>To prevent the uncontrollable increase of the <code>string</code>↔<code>int32</code> map, the budget for creating tag values is limited to
300 per day. Upon exceeding the budget, new mappings can be added twice per hour (this rule is customizable).</p>
<p><strong>Mapping flood</strong> appears when you exceed this budget. When the budget is over and new mappings are not allowed,
StatsHouse inserts a service <code>mapping flood</code> value to a tag column not to lose the entire event.</p>
<p>There are options to use <a href="/statshouse/guides/design-metric#how-many-tag-values">tags with too many different values</a>
and to avoid the mapping flood: <a href="/statshouse/guides/design-metric#string-top-tag">String top</a> tag and
<a href="/statshouse/guides/design-metric#raw-tags">Raw</a> tags.</p>
<img src="/statshouse/assets/images/mapping-6cd5a4098b656c6e86b2617a4eff7558.png" width="600">
<p>If you need a tag with many different 32-bit integer values (such as <code>user_ID</code>), use the
<a href="/statshouse/guides/design-metric#raw-tags">Raw</a> tag values to avoid the mapping flood.</p>
<p>For many different string values (such as <code>search_request</code>), use a <a href="#string-top-tag">String top tag</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="string-top-tag"><em>String top</em> tag<a href="#string-top-tag" class="hash-link" aria-label="Direct link to string-top-tag" title="Direct link to string-top-tag">​</a></h4>
<p>The <em>String top tag</em> stands apart from the other ones as its values are <em>not mapped to integers</em>. It is a separate
<code>stag</code> column in the ClickHouse table:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_size</td><td>JSON<br><text class="orange-text">mapped to <code>int32</code></text></td><td>ok<br><text class="orange-text">mapped to <code>int32</code></text></td><td>my-tag-value<br><text class="orange-text">NOT mapped to <code>int32</code></text></td><td>100</td><td>1300</td><td>20</td><td>1200</td></tr></tbody></table>
<p>As the non-mapped strings take up a lot of space and are longer to read, StatsHouse limits their number (e.g., to a
hundred). This limit is not configurable for users.</p>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>For these <em>String top</em> tag values, StatsHouse stores only the most frequently used ones—those with the highest
<em>counter</em>. The other tag values for this metric become <em>empty</em> and are aggregated.</p></div></div>
<p>For example, the limitation for the non-mapped strings is 4, and we have the following metric data:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>b</td><td>3</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>The next piece of data adds one more row: with the <code>e</code> <em>String top</em> tag value and the counter equal to <code>55</code>.
The <em>String top</em> mechanism chooses the tag value with the lowest count (<code>b</code> is the less popular one) and makes it
<em>empty</em>:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>b</strong> → <em>empty string</em></td><td><strong>3</strong></td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>e</strong></td><td><strong>55</strong></td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>The next piece of data adds one more row: with the <code>f</code> tag value and the counter equal to <code>2</code>.</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><em>empty string</em></td><td>3</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>e</td><td>55</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>f</strong> → <em>empty string</em></td><td><strong>2</strong></td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>As the <code>f</code> tag value is not in the top of the frequently used ones (i.e., it has the low <em>count</em>), it becomes the
empty string too and is aggregated with the previous <em>empty string</em>:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><em>empty string</em></td><td><strong>3+2</strong></td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>e</td><td>55</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="raw-tags"><em>Raw</em> tags<a href="#raw-tags" class="hash-link" aria-label="Direct link to raw-tags" title="Direct link to raw-tags">​</a></h4>
<p>If tag values in your metric are originally 32-bit integer values, you can mark them as the <em>Raw</em> ones
to avoid the mapping flood.
These <em>Raw</em> tag values will be parsed as <code>(u)int32</code> (<code>-2^31..2^32-1</code> values are allowed)
and inserted into the ClickHouse database as is.
Learn how to <a href="/statshouse/guides/edit-metrics#set-up-raw-tags">set up <em>Raw</em> tags</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-budget-for-creating-metrics">The budget for creating metrics<a href="#the-budget-for-creating-metrics" class="hash-link" aria-label="Direct link to The budget for creating metrics" title="Direct link to The budget for creating metrics">​</a></h3>
<p>Users can create as many metrics as they wish as soon as they do it manually via the StatsHouse UI.
As a rule, administrators cannot automate creating metrics.</p>
<p>The StatsHouse components rely on the idea that there are not so many different metrics—hundreds of thousands as a
maximum. StatsHouse is not protected from the uncontrollable increase of the metrics&#x27; number.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>If you migrate to StatsHouse from the other monitoring solution, contact the StatsHouse administrators in your
organization to enable the &quot;Auto-create&quot; mode (and to disable it upon migration).</p></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p><strong>Getting metric properties from metadata</strong></p><p>Aggregators get information directly from the metadata service. Agents deal with the mappings via the aggregators.
Both the agents and the aggregators cache the mappings in memory or in files—for a month.</p><p>Upon initial startup, the agents use the special bootstrap request to get the 100,000 most frequently used mappings.
Otherwise, while deploying the agents on the 10,000 hosts, StatsHouse should have downloaded a billion values one by
one. It would take a lot of time, and StatsHouse would not be able to write metric data.</p><p>Aggregators use the TL/RPC long polling to get metrics&#x27; information from metadata. Similarly, agents use
long polling to get information from aggregators. So, all the agents become informed about the changes in the metrics&#x27;
properties almost immediately (in a second).</p><p><strong>Deleting metrics</strong></p><p>One cannot delete a metric, because there is no efficient way to do it in the ClickHouse database.
StatsHouse uses the <code>visible</code> flag to disable the metric, i.e., to hide the metric from the metric list
(it is reversible). Disabling a metric stops writing data for it to the database.</p></div></div></details></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/statshouse/overview/concepts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Concepts</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/statshouse/support"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Support</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#agent" class="table-of-contents__link toc-highlight">Agent</a><ul><li><a href="#receiving-data-via-udp" class="table-of-contents__link toc-highlight">Receiving data via UDP</a></li><li><a href="#deploying-agents-in-the-kubernetes-pods" class="table-of-contents__link toc-highlight">Deploying agents in the Kubernetes pods</a></li></ul></li><li><a href="#aggregator" class="table-of-contents__link toc-highlight">Aggregator</a><ul><li><a href="#real-time-and-historical-data" class="table-of-contents__link toc-highlight">Real-time and &quot;historical&quot; data</a></li><li><a href="#handling-aggregators-shutdown" class="table-of-contents__link toc-highlight">Handling aggregator&#39;s shutdown</a></li></ul></li><li><a href="#database" class="table-of-contents__link toc-highlight">Database</a></li><li><a href="#application-programming-interface-api" class="table-of-contents__link toc-highlight">Application programming interface (API)</a></li><li><a href="#user-interface-ui" class="table-of-contents__link toc-highlight">User interface (UI)</a></li><li><a href="#ingress-proxy" class="table-of-contents__link toc-highlight">Ingress proxy</a></li><li><a href="#metadata" class="table-of-contents__link toc-highlight">Metadata</a><ul><li><a href="#the-budget-for-creating-tag-values" class="table-of-contents__link toc-highlight">The budget for creating tag values</a></li><li><a href="#the-budget-for-creating-metrics" class="table-of-contents__link toc-highlight">The budget for creating metrics</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 StatsHouse.</div></div></div></footer></div>
</body>
</html>