version: "3.9"

services:
  metadata:
    profiles:
      - sh
      - api-dev
    build:
      context: .
      dockerfile: build/statshouse-metadata.Dockerfile
    container_name: sh-metadata
    command: --statshouse-addr=localhost:13337 --db-path=/var/lib/statshouse/metadata/db --binlog-prefix=/var/lib/statshouse/metadata/binlog/bl
    volumes:
      - metadata:/var/lib/statshouse
    expose:
      - 2442
    network_mode: host
  kh:
    profiles:
      - sh
      - kh
      - api-dev
    build:
      context: .
      dockerfile: build/clickhouse.Dockerfile
    container_name: kh
    hostname: aggregator
    volumes:
      - kh:/var/lib/clickhouse
    expose:
      - 8123
      - 9000
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query='SELECT 1'"]
      interval: 200ms
      timeout: 1s
      retries: 1500
    network_mode: host
  aggregator:
    profiles:
      - sh
      - api-dev
    build:
      context: .
      dockerfile: build/statshouse.Dockerfile
    container_name: sh-aggregator
    command: aggregator --cluster=test_shard_localhost --log-level=trace --agg-addr=':13336' --kh=localhost:8123 --metadata-addr=localhost:2442 --auto-create --cache-dir=/var/lib/statshouse/cache/aggregator
    expose:
      - 13336
    network_mode: host
    depends_on:
      kh:
        condition: service_healthy
  agent:
    profiles:
      - sh
      - api-dev
    build:
      context: .
      dockerfile: build/statshouse.Dockerfile
    container_name: sh-agent
    command: agent --cluster=test_shard_localhost --log-level=trace --agg-addr='localhost:13336,localhost:13336,localhost:13336' --cache-dir=/var/lib/statshouse/cache/agent --remote-write-enabled
    expose:
      - 8081
      - 13337/udp
    network_mode: host
    depends_on:
      - aggregator
  api:
    profiles:
      - sh
    build:
      context: .
      dockerfile: build/statshouse-api.Dockerfile
    container_name: sh-api
    command: --verbose --local-mode --access-log --clickhouse-v1-addrs= --clickhouse-v2-addrs=localhost:9000 --listen-addr=:10888 --metadata-addr=localhost:2442 --statshouse-addr=localhost:13337 --disk-cache=/var/lib/statshouse/cache/api/mapping_cache.sqlite3
    expose:
      - 10888
    network_mode: host
    depends_on:
      kh:
        condition: service_healthy
  all-in-one:
    profiles:
      - all-in-one
    build:
      context: .
      dockerfile: build/all-in-one.Dockerfile
    container_name: all-in-one
    expose:
      - 10888
      - 13337/udp
    network_mode: host
  grafana:
    profiles:
      - api-dev
    image: grafana/grafana-oss
    container_name: grafana
    volumes:
      - grafana:/var/lib/grafana
    expose:
      - 3000
    network_mode: host
  prometheus:
    profiles:
      - api-dev
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - prometheus:/prometheus
      - ${PWD}/build/prometheus.yml:/etc/prometheus/prometheus.yml
    expose:
      - 9090
    network_mode: host

volumes:
  kh:
  metadata:
  prometheus:
  grafana:
