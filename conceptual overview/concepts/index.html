<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-conceptual overview/concepts" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.0">
<title data-rh="true">Concepts | StatsHouse</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://github.com/statshouse/conceptual overview/concepts"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Concepts | StatsHouse"><meta data-rh="true" name="description" content="To understand StatsHouse deeply, learn the basic metric-related concepts:"><meta data-rh="true" property="og:description" content="To understand StatsHouse deeply, learn the basic metric-related concepts:"><link data-rh="true" rel="icon" href="/statshouse/img/statshouse.ico"><link data-rh="true" rel="canonical" href="https://github.com/statshouse/conceptual overview/concepts"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/conceptual overview/concepts" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/conceptual overview/concepts" hreflang="x-default"><link rel="preconnect" href="https://mc.yandex.ru">
<script>!function(e,t,a,c,n,r,i){e[n]=e[n]||function(){(e[n].a=e[n].a||[]).push(arguments)},e[n].l=1*new Date,r=t.createElement(a),i=t.getElementsByTagName(a)[0],r.async=1,r.src="https://mc.yandex.ru/metrika/tag.js",i.parentNode.insertBefore(r,i)}(window,document,"script",0,"ym"),ym(96098475,"init",{defer:!0,clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0,ecommerce:!1,trackHash:!1})</script>
<noscript>
                            <div><img src="https://mc.yandex.ru/watch/96098475" style="position:absolute; left:-9999px;" alt=""></div>
                        </noscript><link rel="stylesheet" href="/statshouse/assets/css/styles.c0a0f5f8.css">
<script src="/statshouse/assets/js/runtime~main.d32e71de.js" defer="defer"></script>
<script src="/statshouse/assets/js/main.babd666a.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#ff4013;color:#ffffff" role="banner"><div class="content_knG7 announcementBarContent_xLdY">This documentation is currently in draft form, so it may be misleading. Please wait until the documentation is officially released.</div></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/statshouse/"><div class="navbar__logo"><img src="/statshouse/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/statshouse/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">StatsHouse Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/VKCOM/statshouse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/">What is StatsHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/quick-start">Quick start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/statshouse/guides/access-cluster">User guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/access-cluster">Get access to StatsHouse</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/design-metric">Design your metric</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/create-metric">Create a metric</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/send-data">Send metric data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/view-graph">View metric data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/edit-metrics">Edit a metric</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/dashboards">Create and view dashboards</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/query-wth-promql">Query with PromQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/guides/openapi">Find OpenAPI specification</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/statshouse/conceptual overview/features">Conceptual overview</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/conceptual overview/features">Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/statshouse/conceptual overview/concepts">Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/conceptual overview/components">Components</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/statshouse/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Conceptual overview</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Concepts</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Concepts</h1>
<p>To understand StatsHouse deeply, learn the basic metric-related concepts:</p>
<ul>
<li><a href="#aggregation">aggregation</a>,</li>
<li><a href="#cardinality">cardinality</a>,</li>
<li><a href="#sampling">sampling</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="aggregation">Aggregation<a href="#aggregation" class="hash-link" aria-label="Direct link to Aggregation" title="Direct link to Aggregation">​</a></h2>
<p>StatsHouse aggregates the events with the same tag sets—both within the time period and between the hosts.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aggregate">Aggregate<a href="#aggregate" class="hash-link" aria-label="Direct link to Aggregate" title="Direct link to Aggregate">​</a></h3>
<p>An <strong>aggregate</strong> is the result of aggregation.
It is the minimal set of descriptive statistics such as <em>count</em>, <em>sum</em>, <em>min</em>, <em>max</em>. StatsHouse uses them to
reconstruct the rest of statistics if necessary.
For example, this is what an aggregate within one second looks like:</p>
<img src="/statshouse/assets/images/per-sec-aggr-a87f3956a65dd5bc7d4e0f7e965a3a9b.png" width="700">
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>StatsHouse does not store an exact metric value per each moment.
Instead, it stores aggregates associated with time intervals
(see more about the <a href="#minimal-available-aggregation-interval">minimal available aggregation interval</a>).</p></div></div>
<p>Upon aggregation, StatsHouse inserts data into the ClickHouse database—specifically, into a per-second table.
The amount of per-second data is huge, so StatsHouse downsamples data: per-second data is available for two days.</p>
<p>StatsHouse aggregates data within a minute and inserts it to a per-minute ClickHouse table.
Similarly, StatsHouse aggregates per-minute data to per-hour one.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="minimal-available-aggregation-interval">Minimal available aggregation interval<a href="#minimal-available-aggregation-interval" class="hash-link" aria-label="Direct link to Minimal available aggregation interval" title="Direct link to Minimal available aggregation interval">​</a></h3>
<p>The currently available aggregate depends on the &quot;age&quot; of the data:</p>
<ul>
<li>per-second aggregated data is stored for the first two days,</li>
<li>per-minute aggregated data is stored for a month,</li>
<li>per-hour aggregated data is available forever (if not deleted manually).</li>
</ul>
<img src="/statshouse/assets/images/min-available-aggregation-25c11af0fb1df0946f0e1187665685b2.png" width="700">
<p>Imagine a hypothetical product. For this product, we need to get the number of received packets per second.
The packets may have different</p>
<ul>
<li>formats: <code>TL</code>, <code>JSON</code>;</li>
<li>statuses: &quot;correct&quot; (<code>ok</code>) or &quot;incorrect&quot; (<code>error_too_short</code>, <code>error_too_long</code>, etc.).</li>
</ul>
<p>When the user-defined code receives a packet, it sends an event to StatsHouse, specifically,
to an <a href="/statshouse/conceptual overview/components#agent">agent</a>.
For example, let this event have a JSON format and a &quot;correct&quot; status:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;metrics&quot;:[ {&quot;name&quot;: &quot;toy_packets_count&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;tags&quot;:{&quot;format&quot;: &quot;JSON&quot;, &quot;status&quot;: &quot;ok&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;counter&quot;: 1}] }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Formats and statuses may vary for the packets:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;metrics&quot;:[ {&quot;name&quot;: &quot;toy_packets_count&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;tags&quot;:{&quot;format&quot;: &quot;TL&quot;, &quot;status&quot;: &quot;error_too_short&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     &quot;counter&quot;: 1} ]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s represent an event as a row in a conventional database. Upon per-second aggregation,
we&#x27;ll get the table below—for each tag value combination received, we get the row with the corresponding count:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>100</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>ok</td><td>200</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>5</td></tr></tbody></table>
<p>The number of rows in such a table is a metric&#x27;s cardinality.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cardinality">Cardinality<a href="#cardinality" class="hash-link" aria-label="Direct link to Cardinality" title="Direct link to Cardinality">​</a></h3>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>Cardinality is how many unique tag value combinations you send for a metric.</p></div></div>
<p>In the example above, the metric&#x27;s cardinality for the current second is <em>three</em> as we have three tag value combinations.</p>
<p>The amount of inserted data does not depend on the number of events. It depends on the number of unique tag
value combinations. StatsHouse &quot;collapses&quot; the rows with the same tag value combinations and summarizes the counters.</p>
<p>StatsHouse collects data from many hosts (<a href="/statshouse/conceptual overview/components#agent">agents</a>) simultaneously. Upon collecting and
aggregating data within a second, it sends data to <a href="/statshouse/conceptual overview/components#aggregator">aggregators</a>.</p>
<img src="/statshouse/assets/images/aggregation-components-dc9f319fb9dfb0b6ddf5c3c030b3dfc4.png" width="1000">
<p>For our hypothetical metric, the between-host aggregation per second leads to the following:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>1100</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>error_too_short</td><td>40</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>error_too_long</td><td>20</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>ok</td><td>30</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>2400</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>msgpack</td><td>ok</td><td>1</td></tr></tbody></table>
<p>Cardinality may increase due to between-host aggregation: the sets of tag value combinations for the hosts may vary.
In the example above, the total cardinality for the current second is <em>six</em>.</p>
<p>The total <a href="/statshouse/guides/view-graph#cardinality">hour cardinality</a> for a metric determines how many
rows for a metric can be stored in a database for a long time.</p>
<p>When retrieving data from a database, we have to iterate over the rows for the chosen time interval. It is
the cardinality that determines the number of these rows and the time we spend on doing this.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="sampling">Sampling<a href="#sampling" class="hash-link" aria-label="Direct link to Sampling" title="Direct link to Sampling">​</a></h2>
<p>StatsHouse has two bottlenecks:</p>
<ul>
<li>sending data from agents to aggregators,</li>
<li>inserting data into the ClickHouse database.</li>
</ul>
<img src="/statshouse/assets/images/bottlenecks-027b934b676924261254ec9e9fb4b586.png" width="1000">
<p>If the amount of sent or inserted data exceeded the aggregator&#x27;s or database&#x27;s capacity, it could lead to a
processing delay. This delay could increase indefinitely or disappear if the amount of data was reduced.
To ensure minimal delay, StatsHouse samples data.</p>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>Sampling means that StatsHouse throws away pieces of data to reduce its overall amount.
To keep aggregates and statistics the same, StatsHouse multiplies the rest of data by a sampling coefficient.</p></div></div>
<p>Suppose we have three data rows per second for a single metric:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>100</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>ok</td><td>200</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>5</td></tr></tbody></table>
<p>Suppose also that the channel width allows us to send only two rows to the aggregator. StatsHouse will set
the sampling coefficient to <code>1.5</code>, then randomize the rows, and send only the first two rows multiplied by <code>1.5</code>.</p>
<p>The data sent will look like this:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>ok</td><td>300</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>150</td></tr></tbody></table>
<p>or like this:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>ok</td><td>300</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>7.5</td></tr></tbody></table>
<p>or like that:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>7.5</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>150</td></tr></tbody></table>
<p>If each agent samples data in this way, it will throw away some rows. Upon aggregating data between the agents,
the counters for the rows will be close to their original values (as if data was not sampled at all).
The more agents aggregate their sampled data, the more accurate the resulting counters are.</p>
<p>The same is true for downsampling data: when StatsHouse aggregates 60-second rows to a one-minute row, or
60-minute rows—to a one-hour row.</p>
<p>The aggregates&#x27; averages will stay the same but will get the high-frequency noise.</p>
<img src="/statshouse/assets/images/cardinality-sampling-noise-58e6825a4c5500c54cef2aac227df503.png" width="900">
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>We strongly <a href="/statshouse/guides/design-metric#how-many-tag-values">recommend reducing metrics&#x27; cardinality</a>.</p></div></div>
<p>The same algorithm applies both when the agents send data to the aggregator and when the aggregator inserts data into
the database.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="non-integer-sampling-coefficients">Non-integer sampling coefficients<a href="#non-integer-sampling-coefficients" class="hash-link" aria-label="Direct link to Non-integer sampling coefficients" title="Direct link to Non-integer sampling coefficients">​</a></h3>
<p>Sampling coefficients should sometimes be non-integer to keep aggregates and statistics the same.
This leads to <a href="/statshouse/guides/view-graph#3--descriptive-statistics">non-integer values for counters</a>,
though each counter is an integer number at its core.</p>
<p>In StatsHouse, counters are floating-point by default.
For a particular metric, you can choose the option to randomly round the sampling coefficients:
if the desired sampling coefficient is <code>1.1</code>, it will be rounded to <code>1</code> nine times out of ten—and it will be rounded to
<code>2</code> only once.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fair-resource-sharing">Fair resource sharing<a href="#fair-resource-sharing" class="hash-link" aria-label="Direct link to Fair resource sharing" title="Direct link to Fair resource sharing">​</a></h3>
<p>Now assume we have more than one metric, and they share the same channel of a given width.
Ideally, the metrics should not affect each other.
If a metric starts generating a lot more rows than the others, it should get the higher sampling coefficient, so that
the other metrics are not affected.</p>
<img src="/statshouse/assets/images/higher-sampling-coef-bb44ce33891709cae6bcba650712bf36.png" width="700">
<p>The algorithm&#x27;s logic is the following:</p>
<ol>
<li>StatsHouse sorts all the metrics in ascending order by a number of occupied bytes. Then it
refers to them one by one.</li>
<li>StatsHouse calculates the number of bytes to grant to each metric. The rest of the budget is shared
between the rest of the metrics.</li>
<li>If a metric does not spend its budget, its data is not sampled at all.</li>
<li>If a metric exceeds its budget, StatsHouse samples it so that the metric data fits in the budget:
for a metric with 2000 rows and the budget of 500 rows, the sampling coefficient is set to 4.</li>
<li>StatsHouse reduces the rest of the budget by the number of bytes spent.</li>
</ol>
<p>The number of occupied bytes depends on the <a href="/statshouse/guides/design-metric#metric-types">metric type</a>
and the number of tag values. <em>Counter</em> metrics require less space than <em>value</em> metrics.</p>
<p>In practice, some metrics are more important than the other. StatsHouse administrators can set up
<a href="/statshouse/guides/edit-metrics#admin-settings">weights</a> for the particular metrics.
A metric having a weight of 2 gets the channel two times as broad as the channel for a 1-weight metric.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sampling-mainstays">Sampling &quot;mainstays&quot;<a href="#sampling-mainstays" class="hash-link" aria-label="Direct link to Sampling &quot;mainstays&quot;" title="Direct link to Sampling &quot;mainstays&quot;">​</a></h3>
<p>The above-mentioned algorithm works fine when the original counters for the rows are close to each other.
Often, a metric has one or several &quot;mainstays&quot; that are dominating rows.
For example, if we successfully process 1000 packets per second,
but we also get one error of each type, the first &quot;ok&quot; row becomes the &quot;mainstay&quot;:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>format</th><th>status</th><th>counter</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_count</td><td>JSON</td><td>ok</td><td>1000 <text class="orange-text">← will not be sampled</text></td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_short</td><td>1</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_long</td><td>1</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_bad</td><td>1</td></tr><tr><td>13:45:05</td><td>toy_packets_count</td><td>TL</td><td>error_too_good</td><td>1</td></tr></tbody></table>
<p>When we display the sum of counters on a graph, we get the flat graph for the <code>1004</code> value.</p>
<p>Imagine, we have to insert only four rows out of five because of a budget.
We will throw away one row per each second:</p>
<ul>
<li>for four seconds out of five the value will be <code>1003 * (5 / 4) ~ 1203</code>,</li>
<li>for one second out of five the value will be <code>4 * (5 / 4) = 5</code>.</li>
</ul>
<p>On average, these values look valid: if we summarize them, we&#x27;ll get <code>1004</code>. But the graph will be located higher than
the average value—around <code>1200</code>—and will have the ravines down to 0.</p>
<p>When StatsHouse has to sample such data (with &quot;mainstays&quot;), it divides the budget in two. The first part of the
budget (two rows in our example) is granted for the non-sampled rows with the maximum counter values.
The second part of the budget is spent for the rest of the rows: the random rows are inserted while the others are
thrown away. Unlike &quot;mainstays,&quot; these &quot;weak&quot; rows get the respectively higher sampling rate.</p>
<p>In our example, StatsHouse will insert the row with the <code>1000</code> counter as is, i.e., will not sample this row. So,
we&#x27;ll get the graph with the average value of <code>1004</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="user-guided-sampling">User-guided sampling<a href="#user-guided-sampling" class="hash-link" aria-label="Direct link to User-guided sampling" title="Direct link to User-guided sampling">​</a></h3>
<p>Though it is better to let StatsHouse <a href="#sampling">sample</a> data for you,
you may want to sample your data before sending them to StatsHouse.
Use this kind of sampling to control the memory footprint.</p>
<p>In this case, you can explicitly specify <code>counter</code> for the <code>value</code> metric:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">`{&quot;metrics&quot;:[{&quot;name&quot;:&quot;my_metric&quot;,&quot;tags&quot;:{},&quot;counter&quot;:6, &quot;value&quot;:[1, 2, 3]}]}`</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This means that the number of events is 6, and the values are sampled—as if the original <code>value</code>
was <code>[1, 1, 2, 2, 3, 3]</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="resolution">Resolution<a href="#resolution" class="hash-link" aria-label="Direct link to Resolution" title="Direct link to Resolution">​</a></h3>
<p>The highest available resolution of data to show on a graph depends on the currently available
<a href="#aggregation">aggregate</a>: you can get per-second data for the last two days, per-minute data for the last month,
and you can get per-hour data for any period you want.</p>
<p>If getting the highest available resolution is not crucial for you, but it is important for you
to reduce <a href="#sampling">sampling</a>, <a href="/statshouse/guides/edit-metrics#resolution">reduce your metric resolution</a>.</p>
<p>For example, you may choose a custom resolution to make the <a href="/statshouse/conceptual overview/components#agent">agent</a>
send data once per five seconds instead of sending per-second data.
StatsHouse will send data five times more rarely and grant five times more rows for the metric.
The processing delay will increase by <strong>ten</strong> seconds:</p>
<ul>
<li>StatsHouse will be collecting data for <strong>five</strong> seconds,</li>
<li>then it will shard data into five partitions,</li>
<li>and will be sending data for the next <strong>five</strong> seconds—one shard per second.</li>
</ul>
<p>This way of sending data ensures fair channel sharing for the metrics with differing resolution.</p>
<p>The resolution level may be a divisor of 60. To avoid jitter on a graph, use the &quot;native&quot; resolution levels:
1, 5, 15, 60 seconds. These levels correspond to levels of details (LOD) in the UI.
If you choose a 2-second resolution level, the events will be distributed between 5-second LODs unevenly—two or
three events per LOD:</p>
<img src="/statshouse/assets/images/lod-ccc79f120c00efa43b6939d6ebd4aed0.png" width="300">
<p>This uneven distribution leads to a jitter on a graph.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/statshouse/conceptual overview/features"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Features</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/statshouse/conceptual overview/components"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Components</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aggregation" class="table-of-contents__link toc-highlight">Aggregation</a><ul><li><a href="#aggregate" class="table-of-contents__link toc-highlight">Aggregate</a></li><li><a href="#minimal-available-aggregation-interval" class="table-of-contents__link toc-highlight">Minimal available aggregation interval</a></li><li><a href="#cardinality" class="table-of-contents__link toc-highlight">Cardinality</a></li></ul></li><li><a href="#sampling" class="table-of-contents__link toc-highlight">Sampling</a><ul><li><a href="#non-integer-sampling-coefficients" class="table-of-contents__link toc-highlight">Non-integer sampling coefficients</a></li><li><a href="#fair-resource-sharing" class="table-of-contents__link toc-highlight">Fair resource sharing</a></li><li><a href="#sampling-mainstays" class="table-of-contents__link toc-highlight">Sampling &quot;mainstays&quot;</a></li><li><a href="#user-guided-sampling" class="table-of-contents__link toc-highlight">User-guided sampling</a></li><li><a href="#resolution" class="table-of-contents__link toc-highlight">Resolution</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 StatsHouse.</div></div></div></footer></div>
</body>
</html>