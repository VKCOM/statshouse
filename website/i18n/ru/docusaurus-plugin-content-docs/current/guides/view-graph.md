---
sidebar_position: 4
---

import Ui from '../img/ui.png'
import TableView from '../img/table-view.png'
import HostMetrics from '../img/host-metrics.png'
import ServiceMetrics from '../img/service-metrics.png'
import RenameGraph from '../img/rename-graph.png'
import TimePeriod from '../img/time-period.png'
import TimeAgo from '../img/time-ago.png'
import AggregationInterval from '../img/aggregation-interval.png'
import TopN from '../img/top-n.png'
import MaxHostEnable from '../img/max-host-enable.png'
import MaxHostRes from '../img/max-host-res.png'
import MaxHost1 from '../img/max-host-1.png'
import MaxHost2 from '../img/max-host-2.png'
import GroupByChoose from '../img/groupby-choose.png'
import GroupByGraph from '../img/groupby-graph.png'
import FilterByTag from '../img/filter-by-tag.png'
import Negate from '../img/negate.png'
import Sort from '../img/sort.png'
import Auto from '../img/auto.png'
import TableChoose from '../img/table-choose.png'
import Overlay1 from '../img/overlay1.png'
import Overlay2 from '../img/overlay2.png'
import Overlay3 from '../img/overlay3.png'
import CSV from '../img/csv.png'
import ReceiveStatus from '../img/receive-status.png'
import BottomN from '../img/bottom-n.png'
import SamplingSrcAggr from '../img/sampling-src-aggr.png'
import SamplingYellowAlert from '../img/sampling-yellow-alert.png'
import HourCardinality from '../img/hour-cardinality.png'
import ReceiveErrorAlert from '../img/receive-error-alert.png'
import MappingFlood from '../img/mapping-flood.png'
import LockY from '../img/lock-y.png'
import Zoom from '../img/zoom.png'
import SwitchDb from '../img/switch-db.png'
import Prom from '../img/prom.png'
import PromQuery from '../img/prom-query.png'
import MetricTabs from '../img/metric-tabs.png'
import MetricTabDelete from '../img/metric-tab-delete.png'
import DeltaResAggr from '../img/delta-res-aggr.png'
import ResYellow from '../img/res-yellow.png'
import ResRed from '../img/res-red.png'

# Как просматривать данные

В StatsHouse данные можно представить в виде графика или [таблицы](#10--таблица), а также скачать как файл
[CSV](#12--csv).
Для сложных сценариев можно использовать [PromQL-запросы](#18--редактор-promql-запросов).
StatsHouse не позволяет просматривать данные через сторонние приложения.

Узнайте, как просматривать данные в StatsHouse: основные возможности обозначены на рисунке внизу, а описания можно 
найти через панель навигации.

<img src={Ui} width="1000"/>

## 1 — Название метрики

Созданные метрики можно найти по названию.

:::warning
Не вносите изменения и не отправляйте данные в чужие метрики — вы можете испортить чьи-то данные.
:::

### Метрики хостов

Часто используемые метрики хостов, например _загрузка процессора_ или _использование диска_, встроены в StatsHouse:

<img src={HostMetrics} width="300"/>

:::tip
Названия метрик хостов начинаются с префикса `host_`.
:::

Список метрик хостов и их реализацию можно найти на 
[GitHub](https://github.com/VKCOM/statshouse/blob/1c45de2c5ecee27a767a4821ed85315c1a0dff49/internal/format/predefined_hardware.go#L37).
Более подробное описание приведено в [руководстве для администраторов](../admin/host-metrics.md).

### Служебные метрики

Метрики, названия которых начинаются с двух подчёркиваний, — это служебные метрики StatsHouse, например:

<img src={ServiceMetrics} width="300"/>

Их нельзя редактировать. Смотрите также раздел [Метаметрики](#13--метаметрики).

### Общие метрики

На уровне организации можно договориться о наборе метрик, которые будут общими для всех подсистем, сервисов, 
микросервисов, прокси и т. д.

### "Как найти создателя метрики?"

В StatsHouse нет отдельного способа, который помог бы узнать, кто создал метрику. 
Иногда эту информацию можно найти в описании метрики. Если её нет, обратитесь к коллегам лично.

### "Как отобразить несколько метрик на графике?"

[Используйте PromQL-запрос](query-wth-promql.md). Чтобы сопоставить метрики, можно [создать дашборд](dashboards.md).
Чтобы изучить взаимосвязи между метриками или событиями, используйте [Наложение событий](#11--наложение-событий).

## 2 — Название графика

Вы можете изменить название графика, не меняя название метрики.

<img src={RenameGraph} width="800"/>

Изменённое название графика сохраняется только в URL.

## 3 — Описательные статистики

Это статистические функции, которые количественно описывают или обобщают данные:
* _count_ и _count/sec_,
* _sum_ и _sum/sec_,
* _average_,
* _stddev_ (standard deviation),
* _minimum_ и _maximum_,
* _unique_ и _unique/sec_
* [кумулятивные функции](#кумулятивные-функции),
* [производные](#производные),
* [перцентили](#перцентили).

В меню могут отображаться статистики, не соответствующие типу вашей метрики. Если выбрать нерелевантную
статистику, значения на графике будут равны нулю. Чтобы в меню не отображались такие статистики,
[укажите тип метрики в разделе редактирования метрики](edit-metrics.md#тип-метрики-aggregation).

:::tip
Если вы выбрали _count_ или _sum_ в качестве статистики, а для интервала агрегации установлено значение _Auto_, 
график может быть сложно интерпретировать.

Лучше выбрать _count/sec_ и _sum/sec_. Вы получите нормализованные данные, которые не зависят от интервала агрегации.
:::

#### "Почему для счётчика отображается нецелое число??"

Системе иногда приходится выбирать нецелые коэффициенты [семплирования](#sampling), чтобы сохранить значения агрегатов и 
статистик. Из-за этого счётчики могут принимать нецелые значения, хотя каждый счётчик по сути является целым числом.

#### Кумулятивные функции

Накопленные значения нельзя посмотреть для типа _unique_.

#### Производные

Производная показывает скорость изменения исходной функции, то есть разность между двумя ближайшими
значениями функции.

#### Перцентили

Перцентили доступны только для _value_-метрик.
Включить запись перцентилей можно в [разделе редактирования метрики](edit-metrics.md#перцентили-percentiles).

Обратите внимание, что объём данных для метрики с перцентилями увеличивается, — это может 
привести к усилению [семплирования](../overview/concepts.md#семплирование). Чтобы минимизировать коэффициент 
семплирования, следите за [кардинальностью](#cardinality) метрики или уменьшите её 
[разрешение](edit-metrics.md#разрешение-resolution).

## 4 — Период времени

Просматривайте данные за конкретный период времени: последние пять минут, последний час, последнюю неделю. 
Даже за последние два года.

Можно выбрать конкретную дату и время. А ещё настройки можно комбинировать: например, 
так отобразятся данные за последний час для предыдущего дня:

<img src={TimePeriod} width="500"/>

Данные за определённый период времени можно сравнить с данными за аналогичный период в прошлом: на день, неделю или год раньше.

<img src={TimeAgo} width="300"/>

Настраивая период времени, обращайте внимание на то, какой [интервал агрегации](#6--интервал-агрегации)у вас выбран.

:::tip
Убедитесь, что период времени больше, чем интервал агрегации: например, период времени равен семи дням, 
а интервал агрегации — 24 часам.
:::

Чтобы просматривать данные в режиме реального времени, используйте [Live mode](#5--live-mode).

## 5 — Live mode

Используйте _Live mode_, чтобы просматривать данные в режиме реального времени.

По умолчанию параметр _Live mode_ не содержится в URL графика.

:::tip
Чтобы отправить ссылку на график с включенным параметром _Live mode_, добавьте строку `live=1` в URL графика.
:::

## 6 — Интервал агрегации

Интервал агрегации — это что-то вроде степени детализации для вашей метрики. 
Чем больше интервал агрегации, тем более сглаженным выглядит график:

<img src={AggregationInterval} width="600"/>

### _Auto_ и _Auto (low)_

Если выбрать значение _Auto_, для отображения данных на графике будет использоваться минимальный интервал 
агрегации из доступных. Он изменчив, поскольку зависит от того, какие данные доступны в данный момент:
* данные, агрегированные по секундам, хранятся в течение первых двух дней,
* данные, агрегированные по минутам, хранятся в течение месяца,
* данные, агрегированные по часам, хранятся как угодно долго.

Доступный интервал агрегации также связан с [разрешением](../overview/concepts.md#разрешение) метрики.

Интервал агрегации _Auto (low)_ уменьшает отображаемое разрешение на постоянную величину. Он делает график более 
гладким даже при просмотре данных с минимальным интервалом агрегации:

<img src={Auto} width="1000"/>

### 6a — "Дельта"

:::info
Описываемая ниже функциональность будет перерабатываться.
:::

Значение Δ ("дельта") показывает, какому интервалу агрегации (разрешению) соответствует интервал между соседними
точками на графике.

1. При выборе **конкретного интервала агрегации** (не _Auto_ или _Auto (low)_, а, например, _1 second_, _5 minutes_, _1
   hour_ и т.п.) "дельта" показывает, какая агрегация отобразится на графике в итоге.

От чего она зависит?
* От того, с каким **[исходным разрешением](#6b--пользовательское-разрешение)** пишется метрика.
Стандартное — раз в секунду, но вы можете отправлять данные, например, раз в пять секунд.
* От **[доступного интервала агрегации](../overview/concepts.md#минимальный-доступный-интервал-агрегации)**.
Секундные данные доступны в течение двух дней, потом превращаются в минутные и часовые.
* От **[выбранного интервала агрегации](#6--интервал-агрегации)**.
Например, вам доступны секундные агрегаты, но вы выбираете агрегацию в один час.
* От **[выбранного периода времени](#4--период-времени)**.
Вы можете просматривать данные за час (нужно отобразить меньше точек) или за неделю (нужно больше точек).

2. При выборе **интервала агрегации [_Auto_ или _Auto (low)_](#auto-и-auto-low)** "дельта" показывает минимальный доступный интервал
   агрегации **с
   учётом разрешения дисплея**. Разрешение дисплея влияет на размер графика в пикселях. Бывает, что размер графика не
   позволяет отобразить столько точек, сколько требуется. В итоге данные отображаются с более низким разрешением.

Если вы выбираете интервал агрегации _Auto_ или _Auto (low)_, рекомендуем использовать статистики _count/sec_ и
_sum/sec_. Если вы всё же используете _count_ и _sum_, обращайте внимание на "дельту". В этой ситуации статистика
показывает количество событий за промежуток времени, указанный в значении "дельты", и может варьироваться вместе
с ней.

:::tip
#### Как это работает на практике?

Допустим, у StatsHouse есть подробные данные для метрики:
* она изначально пишется с высоким, хотя и не максимальным, разрешением (5 секунд);
* данные ещё очень свежие (не превратились в минутные или часовые агрегаты);
* вы выбрали в интерфейсе небольшой интервал агрегации (тоже 5 секунд).

Но:
* вы запросили данные за большой период времени (за неделю).

StatsHouse отобразит данные с разрешением _НЕ в 5 секунд_ (как вы хотели), а _в
300 секунд_: данные с таким интервалом агрегации (Δ300s) уместились на график.

<img src={DeltaResAggr} width="1000"/>

:::

### 6b — Пользовательское разрешение

Если владелец [настроил пользовательское разрешение](edit-metrics.md#разрешение-resolution) для метрики,
оно будет отображаться над графиком в виде жёлтого значка.

<img src={ResYellow} width="800"/>

Если значение пользовательского разрешения больше, чем выбранный интервал агрегации, значок станет красным.

<img src={ResRed} width="1000"/>

## 7 — Теги

С помощью тегов можно фильтровать и группировать данные.

Чтобы отобразить на графике нужные значения тега, выберите их в выпадающем меню.

<img src={FilterByTag} width="400"/>

:::tip
Если у вашей метрики меньше 16 тегов, ненужные теги можно [скрыть](edit-metrics.md#теги).
:::

### Группировка по тегам

Данные можно сгруппировать по одному или нескольким тегам.

Если у тегов много значений или они образуют много комбинаций, используйте параметр [Top N](#8--top-n): 
укажите, сколько комбинаций с максимальными значениями нужно показать на графике.

<img src={GroupByChoose} width="400"/>

Например, вот как выглядят данные, сгруппированные по тегу `protocol`, если для параметра _Top N_
выбрано значение _Top 3_.

<img src={GroupByGraph} width="600"/>

:::note
По умолчанию данные отображаются на графике без группировки. Задать группировку по умолчанию для метрики нельзя.
:::

### Сортировка по алфавиту

Значения тегов в выпадающем меню можно отсортировать в алфавитном порядке — так можно быстрее найти нужное значение:

<img src={Sort} width="400"/>

### Отмена следующего выбора

Выберите значение тега, чтобы _исключить_ данные из графика:

<img src={Negate} width="400"/>

## 8 — Top N

Когда вы группируете данные по одному или нескольким тегам, например, по _environment_ и _platform_, 
значения тегов могут образовывать много комбинаций:

| Environment × Platform | `web` | `iphone` | `android` |
|:----------------------:|:-----:|:--------:|:---------:|
|      `production`      |  ✔️   |    ✔️    |    ✔️     |
|       `staging`        |  ✔️   |    ✔️    |    ✔️     |
|       `testing`        |  ✔️   |    ✔️    |    ✔️     |

Если комбинаций слишком много, используйте параметр _Top N_: укажите, сколько комбинаций с максимальными значениями 
нужно показать на графике.

Если выбрать значение _Top 3_ для этого параметра в нашем примере, получится вот что:

<img src={TopN} width="900"/>

Чтобы выбрать комбинации с минимальными значениями, выберите один из вариантов _Bottom N_ в том же меню:

<img src={BottomN} width="150"/>

## 9 — Max host

Чтобы найти хост, который отправляет максимальное значение для конкретной метрики, используйте параметр 
[Max host](design-metric.md#имя-хоста-как-тег).

<img src={MaxHostEnable} width="100"/>

Просмотрите список всех хостов, отсортированных по максимальному значению, или скопируйте список в буфер обмена:

<img src={MaxHostRes} width="600"/>

Понятие максимального значения имеет смысл только для выбранного периода времени.

Если включить _Max host_ и просматривать график целиком, отобразится хост, ответственный за отправку 
значения, которое является максимальным за весь [период времени](#4--период-времени) — _Last 24 hours_ в примере ниже:

<img src={MaxHost1} width="900"/>

Если навести курсор на график, результирующее значение _Max host_ будет меняться. Будет отображаться
хост, который отправил значение, максимальное для доступного [интервала агрегации](#6--интервал-агрегации).
В приведённом ниже примере будет показано максимальное значение для минуты, на которую вы указываете:

<img src={MaxHost2} width="900"/>

## 10 — Таблица

События метрики можно отображать в виде таблицы:

<img src={TableView} width="900"/>

Столбцы с тегами можно показать или скрыть (значок "глаз") или сгруппировать по ним ("галочка"):

<img src={TableChoose} width="500"/>

## 11 — Наложение событий

Чтобы найти корреляции в данных, можно наложить события одной метрики на данные другой.

1. Выберите метрику, на которую нужно наложить события. Откройте новую [вкладку метрики](#19--вкладки-метрик):

<img src={Overlay1} width="900"/>

2. На новой вкладке выберите вторую метрику — ту, события которой вас интересуют. Отобразите эту метрику в виде 
[таблицы](#10--таблица):

<img src={Overlay2} width="900"/>

3. Вернитесь к первой метрике. В выпадающем меню _Event overlay_ выберите открытую ранее вторую метрику.
Флажки событий отобразятся на графике:

<img src={Overlay3} width="900"/>

## 12 — CSV

Данные метрики за выбранный период времени можно экспортировать в виде файла CSV:

<img src={CSV} width="800"/>

## 13 — Метаметрики

Метрики с двумя подчёркиваниями в начале — это метаметрики. Самые важные из них отображаются в интерфейсе:

* [Receive status](#receive-status)
* [Sampling](#sampling)
* [Cardinality](#cardinality)
* [Mapping status](#mapping-status)

Некоторые из этих метрик вообще не семплируются. Метрики _Receive status_ и _Sampling_
отправляются в специальной компактной форме для экономии трафика.

### Receive status

Эта метаметрика перенаправляет вас на метрику `__src_ingestion_status`.
Она показывает, есть ли ошибки при получении метрик: правильно ли отформатированы данные,
не имеет ли счётчик отрицательного значения, не отправлено ли значение `NaN`.

Красный значок метаматрики сообщает о наличии ошибок:

<img src={ReceiveErrorAlert} width="800"/>

Вот примеры ошибок:

<img src={ReceiveStatus} width="300"/>

К примеру, теги `err_map_per_metric_queue_overload`, `err_map_tag_value` или `err_map_tag_value_cached` 
указывают на замедление или ошибки в работе [маппинга](../overview/components.md#сервис-метаданных).

Эта метрика использует бюджет той метрики, к которой относится, поэтому большое количество ошибок не может повлиять на 
другие метрики.

Статусы `err_*_utf8` хранят исходные значения строк в формате `hex`.

### Sampling

В StatsHouse есть два узких места: отправка данных от агентов к агрегаторам и вставка данных в базу ClickHouse.
Агент также называют _source (источник)_, потому что это та машина, с которой поступают данные.

[Семплирование](../overview/concepts.md#семплирование) означает, что StatsHouse выбрасывает часть данных, 
чтобы уменьшить их общий объём. Чтобы сохранить значения агрегатов и статистик, StatsHouse домножает оставшиеся 
данные на коэффициент семплирования.

Метаметрика _Sampling source/aggregator_ даёт информацию о коэффициентах семплирования на уровне агента и агрегатора:
* `__src_sampling_factor` — для агента,
* `__agg_sampling_factor` — для агрегатора.

Из-за нецелых коэффициентов семплирования могут появляться 
[нецелые значения счётчиков](#почему-для-счётчика-отображается-нецелое-число).

Если коэффициент семплирования больше 1, появляется жёлтый значок.

<img src={SamplingYellowAlert} width="800"/>

Если коэффициент семплирования больше 5, появляется красный значок.

<img src={SamplingSrcAggr} width="810"/>

Статистика _count_ для этой метрики показывает количество агентов, на которых такой коэффициент был установлен в 
конкретную секунду.

Узнайте больше об [агентах](../overview/components.md#агент) и
[агрегаторах](../overview/components.md#агрегатор) StatsHouse, а также о том, что такое 
[семплирование](../overview/concepts.md#семплирование).

### Cardinality

[Кардинальность](../overview/concepts.md#кардинальность) — это количество уникальных комбинаций значений тегов, которые вы отправляете для метрики.

Метаметрика _Cardinality_ перенаправляет вас на метрику `__agg_hour_cardinality`:

<img src={HourCardinality} width="600"/>

Эта метрика отражает общую часовую кардинальность для конкретной метрики.
Под общей часовой кардинальностью понимается линейная интерполяция между значениями кардинальности для соседних часов.

Оценка кардинальности основана на данных от всех агрегаторов и их шардов.
Статистика _avg_ для этой метрики показывает полную кардинальность — данные можно сгруппировать по агрегаторам.

### Mapping status

Если вы создаёте теги с большим числом значений, которые ещё не были добавлены в маппинг, возникают ошибки 
переполнения [маппинга](../overview/components.md#бюджет-на-создание-значений-тегов):

<img src={MappingFlood} width="800"/>

Ошибки переполнения маппинга указывают на то, что количество новых значений тегов превышает 
[соответствующий дневной бюджет](../overview/components.md#бюджет-на-создание-значений-тегов).
Узнайте больше о [маппинге](../overview/components.md#сервис-метаданных)
и о том, [сколько значений тегов можно использовать](design-metric.md#сколько-значений-тегов-можно-использовать).

## 14 — Фиксированная ось Y

По умолчанию ось Y масштабируется автоматически — сама подстраивается под амплитуду данных.
Возможно, вам понадобится зафиксировать её масштаб.

Представьте, например: данные варьируются в диапазоне от 1 до 100. Иногда появляются пики. StatsHouse обычно 
подстраивает масштаб оси Y под размер пика. Это бывает не очень удобно, когда вас интересуют не пики, а остальные данные.

Фиксируя ось Y, вы отключаете автомасштабирование и можете просматривать данные в заданном диапазоне значений
независимо от пиков.

<img src={LockY} width="1000"/>

:::info
Если вам нужна логарифмическая шкала, перейдите в [редактор PromQL-запросов](#18--редактор-promql-запросов).
Используйте стандартные функции PromQL:
* [`ln()`](https://prometheus.io/docs/prometheus/1.8/querying/functions/#ln)
* [`log2()`](https://prometheus.io/docs/prometheus/1.8/querying/functions/#log2)
* [`log10()`](https://prometheus.io/docs/prometheus/1.8/querying/functions/#log10)
:::

## 15 — Копирование ссылки в буфер обмена

Если вы настроили параметры графика (например, сгруппировали или отфильтровали данные по тегам),
вы можете поделиться ссылкой — параметры сохранятся в URL.

Обратите внимание: единственный параметр, который не включается в ссылку, — это _Live mode_.
Узнайте, [как отправить ссылку на график с включенным параметром _Live mode_](#5--live-mode).

Если у вас открыто несколько [вкладок с метриками](#19--вкладки-метрик),
скопируется только ссылка на текущую вкладку.

Также посмотрите, как [открыть ссылку на график в новой вкладке браузера](#20--график-в-новой-вкладке-браузера).

## 16 — Масштабирование

Перемещайтесь по шкале времени, увеличивайте или уменьшайте масштаб по осям X и Y.

Чтобы вернуться к исходному виду, сбросьте масштабирование (_Reset zoom_):

<img src={Zoom} width="300"/>

Отключите автомасштабирование оси Y, [зафиксировав её](#14--фиксированная-ось-y).

## 17 — Переключение базы данных

Когда-то в StatsHouse использовалась более медленная база данных. В большинстве случаев не нужно переключаться на 
неё. Вы не увидите данных, но появится предупреждение:

<img src={SwitchDb} width="800"/>

Эта функциональность будет отключена позже.

## 18 — Редактор PromQL-запросов

Чтобы расширить возможности работы с данными, мы поддержали PromQL 
([Prometheus Query Language](https://prometheus.io/docs/prometheus/latest/querying/basics/)).

Переключитесь в режим редактирования PromQL-запросов, чтобы реализовать более сложные сценарии просмотра данных:

<img src={Prom} width="300"/>

StatsHouse автоматически сгенерирует для вашего графика PromQL-запрос, описывающий текущее состояние графика.
Выполнить запрос можно в самом редакторе.

Чтобы переключиться обратно в "кнопочный" режим настройки графика, нажмите _Filter_:

<img src={PromQuery} width="300"/>

Узнайте больше о том, как [работать с PromQL-запросами](query-wth-promql.md).

## 19 — Вкладки метрик

Вкладки метрик помогают [создавать дашборды](dashboards.md) и 
[накладывать события одной метрики на данные другой](#11--наложение-событий).
Скопируйте текущий график на новую вкладку и выберите другую метрику.
Также можно скопировать URL графика и вставить его на новую вкладку метрики:

<img src={MetricTabs} width="400"/>

При необходимости вкладку можно удалить:

<img src={MetricTabDelete} width="400"/>

## 20 — График в новой вкладке браузера

Вместо того чтобы [_копировать ссылку на график в буфер обмена_](#15--копирование-ссылки-в-буфер-обмена), можно открыть её в новой 
вкладке браузера.

Как и при [копировании ссылки](#15--копирование-ссылки-в-буфер-обмена), в новой вкладке открывается только текущая вкладка 
метрики, а режим _Live mode_ не включается автоматически.
