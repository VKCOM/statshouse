---
sidebar_position: 7
---

# Как работать с PromQL

В этом разделе можно узнать об особенностях поддержки PromQL в StatsHouse:
<!-- TOC -->
* [Что такое PromQL?](#что-такое-promql)
* [Редактор PromQL-запросов](#редактор-promql-запросов)
* [Особенности поддержки PromQL в StatsHouse](#особенности-поддержки-promql-в-statshouse)
  * [Результат выполнения запроса — это агрегат](#результат-выполнения-запроса--это-агрегат)
  * [Выбор компонентов агрегата с помощью селектора __what__](#выбор-компонентов-агрегата-с-помощью-селектора-what)
  * [Гистограммы в StatsHouse — это структуры _t-digest_](#гистограммы-в-statshouse--это-структуры-t-digest)
  * [По умолчанию группировка не выполняется](#по-умолчанию-группировка-не-выполняется)
* [Расширения PromQL в StatsHouse](#расширения-promql-в-statshouse)
  * [__what__ и __by__](#what-и-by)
  * [Привязывание переменных на дашборде](#привязывание-переменных-на-дашборде)
  * [_Range vector_ и _instant vector_](#range-vector-и-instant-vector)
  * [_Prefix sum_](#prefix-sum)
  * [__default__](#default)
<!-- TOC -->

## Что такое PromQL?

PromQL (Prometheus Query Language) — это язык запросов для работы с временными рядами в системе Prometheus.

Мы решили поддержать PromQL, чтобы расширить возможности работы с данными в StatsHouse.
PromQL предоставляет нужную функциональность, широко используется и хорошо документирован.

Познакомьтесь с [оригинальной документацией PromQL](https://prometheus.io/docs/prometheus/latest/querying/basics/).

## Редактор PromQL-запросов

Чтобы открыть редактор PromQL-запросов, нажмите кнопку `< >` рядом с полем выбора метрики.
Узнайте больше о [редакторе PromQL-запросов](view-graph.md#18--редактор-promql-запросов).

## Особенности поддержки PromQL в StatsHouse

Если у вас уже есть опыт работы с PromQL, вам важно знать, чем отличается поддержка PromQL в StatsHouse от 
привычного вам PromQL в системе Prometheus:

* [Результат выполнения запроса — это агрегат](#результат-выполнения-запроса--это-агрегат), а не точное значение метрики в 
  каждый момент времени.
* Выбрать [компоненты агрегата](#выбор-компонентов-агрегата-с-помощью-селектора-what) можно с помощью селектора `__what__`.
* Гистограммы в StatsHouse [представляют собой структуры _t-digest_](#гистограммы-в-statshouse--это-структуры-t-digest).
* В StatsHouse [не выполняется группировка по умолчанию](#по-умолчанию-группировка-не-выполняется).

### Результат выполнения запроса — это агрегат

Система Prometheus хранит пары `временная метка-значение`. В отличие от Prometheus, StatsHouse хранит агрегированные 
данные, относящие ко временным интервалам ([_агрегаты_](../overview/concepts.md#агрегат)).

Результат выполнения PromQL-запроса в StatsHouse зависит от
* [_минимального доступного интервала агрегации_](../overview/concepts.md#минимальный-доступный-интервал-агрегации)
  (т.е. от «возраста» данных),
* [_запрашиваемого интервала агрегации_](view-graph.md#6--интервал-агрегации),
* [_разрешения_](../overview/concepts.md#разрешение) метрики.

[Агрегат](../overview/concepts.md#агрегат) содержит статистики _count_, _sum_, _min_, _max_, а также иногда тег 
[_String top_](../overview/components.md#тег-string-top-топ-строк) (`tag_s`)
и [перцентили](edit-metrics.md#перцентили-percentiles) (при условии, что их запись включена).
Они являются _компонентами агрегата_:

| timestamp | metric     | tag_1 | tag_2 | tag_s | count | sum | min | max | percentiles |
|-----------|------------|-------|-------|-------|-------|-----|-----|-----|-------------|
| 13:45:05  | toy_metric | ...   | ...   | ...   | ...   | ... | ... | ... | ...         |

Узнайте больше об [агрегации](../overview/concepts.md#агрегация) в StatsHouse.

### Выбор компонентов агрегата с помощью селектора __what__

* В системе Prometheus можно запрашивать точные значения. Prometheus хранит пары `временная метка-значение`, 
  где значение — число с плавающей точкой, привязанное к конкретному моменту времени.
* В StatsHouse можно запрашивать только агрегаты, относящиеся к временному интервалу.

Чтобы получить компонент агрегата в StatsHouse, используйте селектор `__what__`. Вот список возможных значений:

```
"avg"
"count"
"countsec"
"max"
"min"
"sum"
"sumsec"
"stddev"
"stdvar"
"p25"
"p50"
"p75"
"p90"
"p95"
"p99"
"p999"
"cardinality"
"cardinalitysec"
"unique"
"uniquesec"
```

Это те же самые [описательные статистики](view-graph.md#3--описательные-статистики), которые можно выбирать в 
"кнопочном" интерфейсе StatsHouse. Постфикс "sec" означает, что значение нормализовано (поделено на интервал 
агрегации в секундах).

Например, этот селектор возвращает счётчик для метрики `api_requests`, привязанный к интервалу агрегации:
```
api_requests{__what__="count"}
```

Если в селекторе `__what__` не указано значение, StatsHouse попытается "угадать" нужную вам статистику, основываясь на 
функциях PromQL, которые вы используете в своем запросе:

| PromQL functions                                                         | StatsHouse interpretation |
|--------------------------------------------------------------------------|---------------------------|
| "increase"<br/>"irate"<br/>"rate"<br/>"resets"                           | `__what__="count"`        |
| "delta"<br/>"deriv"<br/>"holt_winters"<br/>"idelta"<br/>"predict_linear" | `__what__="avg"`          |

Например, этот запрос возвращает `rate` счётчика метрики `api_requests` за пять минут:
```
rate(api_requests[5m])
```

Если "угадать" статистику не удаётся, StatsHouse возвращает счётчик для [_counter_-метрик](design-metric.md#счётчики-тип-counter)
и среднее значение (сумму, делённую на счётчик) для [_value_-метрик](design-metric.md#значения-тип-value).

### Гистограммы в StatsHouse — это структуры _t-digest_

В Prometheus есть «обычные» и «нативные» гистограммы. Скоро StatsHouse сможет поддержать «обычные». Больше 
информации о поддержке гистограмм появится, когда будет полностью реализована функциональность 
[скрейпинга](../admin/migrating.md#как-перейти-с-prometheus).
Сейчас рекомендуется использовать гистограммы StatsHouse.

StatsHouse хранит гистограммы как _t-digest_. По умолчанию гистограммы для метрики не строятся — нужно
[включить запись перцентилей](edit-metrics.md#перцентили-percentiles) вручную.

Указать необходимый перцентиль нужно в селекторе `__what__`:

```
"p25"
"p50"
"p75"
"p90"
"p95"
"p99"
"p999"
```

Например, следующее выражение вернёт 99-й перцентиль:

```
api_requests{__what__="p99"}
```

### По умолчанию группировка не выполняется

Если запросить данные в Prometheus по имени метрики, система вернёт все ряды данных для этой метрики —— все 
комбинации тегов.

В отличие от Prometheus, StatsHouse вернёт результат агрегирования. Например, запрос метрики "api_requests" в StatsHouse
возвращает одну строку. Чтобы сгруппировать данные по тегам, укажите нужные теги, используя оператор `__by__`.

## Расширения PromQL в StatsHouse

Поддержка PromQL в StatsHouse включает в себя ряд расширений.

### ___what___ и ___by___

Селекторы [`__what__`](#выбор-компонентов-агрегата-с-помощью-селектора-what) и [`__by__`](#по-умолчанию-группировка-не-выполняется) 
помогают выразить стандартные запросы.

### Привязывание переменных на дашборде

Чтобы привязать тег к созданной ранее переменной, используйте следующий синтаксис в PromQL-запросе:

`tag_name:$variable_name`

В результате запрос может выглядеть примерно так:

`topk(5,api_requests{@what="countsec",0:$env})`

Узнайте больше о 
[настройке переменных на дашборде с использованием PromQL-графиков](dashboards.md#настройка-дашборда-с-использованием-promql-графиков).

### _Range vector_ и _instant vector_

Функции над `range vector` также принимают `instant vector`, но не наоборот.

### _Prefix sum_

Функция `prefix_sum` вычисляет префиксную сумму. Например, для последовательности `1, 2, 3, 4, 5, 6` она вернёт `1, 3,
6, 10, 15, 21`.

### _default_

Это бинарный оператор. Слева он принимает ряд, а справа — ряд или литерал.
* Если справа находится литерал, то значения `NaN` слева будут заменены на значение литерала справа.
* Если справа находится ряд, то логика сопоставления рядов такая же, как и для оператора `or`. Значения `NaN`
  слева заменяются соответствующими значениями справа.
