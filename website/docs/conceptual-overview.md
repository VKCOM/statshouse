---
sidebar_position: 5
---

# Conceptual overview


## Metriсs


Дайджест для всех типов одинаковый
Если не тот тип значения, просто подставятся нули. Чтобы не показывать лишние нули, выберите правильную галочку в UI.



counter— простой счётчик, statlogsXCountEvent подсчитает сумму числа событий в секунду.
value— counter плюс значение. statlogsXValueEvent подсчитает в дополнение к сумме числа событий ещё и минимальное, максимальное, среднее от значений. Значения имеют тип float64.
percentile— value с разбивкой по перцентилям, дорогое удовольствие, так что такой тип можно задать только с помощью админа. Записывается идентичным с value образом — statlogsXValueEvent, перцентили будут писаться если в свойствах метрики установлен соответствующий тип.
unique— counter плюс кардинальность (уники). statlogsXUniqueCount подсчитает в дополнение к сумме числа событий ещё и оценку количества разных значений. Значения имеют тип int64.


string top— топ строк. statlogsXStringTop выберет самые популярные строки и подсчитает количество каждой, плюс количество невошедших в топ.
В новом коде всегда используйте функции семейства statlogsX*, принимающие массив ключей, например, statlogsXCountEvent, а не statlogsCountEvent.

Все метрики в StatsHouse содержат счётчик событий, так что не нужно писать его отдельно. В данном примере первая строчка не нужна, так как unique и так содержит число событий:

    statlogsCountEvent(self::STATS_KEY, $block, $action, test_getFeedRightAppsBlockGroup($user_id)); // WRONG
    statlogsUniqueCount(self::STATS_USERS_KEY, $user_id, $block, $action, test_getFeedRightAppsBlockGroup($user_id));
Лучше так не делать, но разные комбинации ключей могут одной метрики могут записываться функциями для разных типов,
тогда можно указать тип метрики как mixed или mixed_p (с записью перцентилей). В этом случае система позволит писать
и отображать все типы данных для этой метрики. Некоторые любят создавать одну метрику для подсистемы, и разбить её
на "под-метрики" с помощью разных значенийkey1. Можно и так, но тогда тип метрики придётся задать, как mixed. Также
для такой метрики будет выбран единый фактор сэмплирования и будет невозможно задать описания ключей (ведь они
скорее всего будет зависеть от key1). В новом коде mixed метрик следует избегать.





## Mapping and budgets for creating metrics

You cannot automate creating metrics. This limitation is related to a StatsHouse mapping mechanism. See more about
[mapping and budgets for creating metrics].

Правда ли что в сутки можно писать только 200 комбинаций ключей?
Не правда, у нас есть 2 механизма ограничений, первый связан с отображениями строковых значений ключей в целые, второй с лимитом записи в базу под каждую метрику.

В ClickHouse мы используем для хранения ключей тип int32, это в 10-20 раз быстрее, чем хранить строки.
При записи метрики строковые значения нужно превратить в целочисленные. Для этого используется глобальное отображение string int32.
Это общий ресурс, а значит есть ограничение на создание элементов в нём, но только на создание.

Исторически установлено примитивное ограничение в 100 ключей в день, что позволяет каждой метрике создать 70000+ ключей в год. Это очень много и привело к чудовищному росту отображения (60+ гигабайтов), поэтому скоро мы перейдём на использование бюджета в (например) 300 ключей, который будет восполняться (например) по 5 ключей в день. То есть если вы долго не создавали ключей, можете сразу создать 600, но после этого только 5 в день. Если не создавать ключи 60 дней, бюджет полностью восстановится.

После того, как строковые ключи отображены в целочисленные, при вставке в базу получится какое-то количество строк, по одной на каждую использованную комбинацию ключей. Сейчас мы разрешаем использовать примерно 50000 комбинаций в час, если больше - произойдет сэмплирование, то есть часть рядов будет выкинуты а оставшиеся умножены на выбранный фактор. Если система перегружена, временно может быть выбран и больший фактор, чтобы осталось меньше рядов.




## Aggregation

## Digest

## Sampling

Семплирование обычно не мешает, но может быть проблемой. Если важно не терять данные и не иметь нули.



aggregate

digest

tag

cardinality

sampling

resolution

units

For all these metrics, you cannot get an absolute value for a given timestamp. You cannot say exactly
how many requests were sent to a service at a particular moment in time. Instead, you can get _aggregated_
information, i.e., a _digest_.

Сбор данных происходит одновременно на многих машинах-агентах. После того, как сбор и агрегация данных за секунду завершены,
данные отправляются на машины-агрегаторы, которые агрегируют данные со всех агентов


Данные соответствуют не абсолютной точке, а интервалу. Мы храним не число, а агрегат
  Отразить особенности реального процесса:
  События процесса могут полностью нами контролироваться
  Когда мониторим текущее потребление памяти на сервере — можем сколько-то раз в секунду провести измерение — получаем
  агрегат. Сохраняем минимум, максимум, сумму, количество
  Ассоциируем агрегат с отрезком времени


