<!doctype html>
<html lang="ru-RU" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-overview/components" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Компоненты | StatsHouse</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://github.com/statshouse/ru/overview/components"><meta data-rh="true" property="og:locale" content="ru_RU"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="ru"><meta data-rh="true" name="docsearch:language" content="ru"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Компоненты | StatsHouse"><meta data-rh="true" name="description" content="Основные компоненты StatsHouse изображены на рисунке:"><meta data-rh="true" property="og:description" content="Основные компоненты StatsHouse изображены на рисунке:"><link data-rh="true" rel="icon" href="/statshouse/ru/img/statshouse.ico"><link data-rh="true" rel="canonical" href="https://github.com/statshouse/ru/overview/components"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/overview/components" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/ru/overview/components" hreflang="ru-RU"><link data-rh="true" rel="alternate" href="https://github.com/statshouse/overview/components" hreflang="x-default"><link rel="preconnect" href="https://mc.yandex.ru">
<script>!function(e,t,a,c,n,r,i){e[n]=e[n]||function(){(e[n].a=e[n].a||[]).push(arguments)},e[n].l=1*new Date,r=t.createElement(a),i=t.getElementsByTagName(a)[0],r.async=1,r.src="https://mc.yandex.ru/metrika/tag.js",i.parentNode.insertBefore(r,i)}(window,document,"script",0,"ym"),ym(96098475,"init",{defer:!0,clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0,ecommerce:!1,trackHash:!1})</script>
<noscript>
                            <div><img src="https://mc.yandex.ru/watch/96098475" style="position:absolute; left:-9999px;" alt=""></div>
                        </noscript><link rel="stylesheet" href="/statshouse/ru/assets/css/styles.a17eb7a5.css">
<script src="/statshouse/ru/assets/js/runtime~main.e3c97caf.js" defer="defer"></script>
<script src="/statshouse/ru/assets/js/main.3dc6f218.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Перейти к основному содержимому"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Перейти к основному содержимому</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Переключить навигационную панель" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/statshouse/ru/"><div class="navbar__logo"><img src="/statshouse/ru/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/statshouse/ru/img/statshouse.jpeg" alt="StatsHouse Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Документация StatsHouse</b></a><div class="navbar__item dropdown dropdown--hoverable"><a aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link" href="/statshouse/ru/overview/components"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>Русский</a><ul class="dropdown__menu"><li><a href="/statshouse/overview/components" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-US">English</a></li><li><a href="/statshouse/ru/overview/components" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="ru-RU">Русский</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://github.com/VKCOM/statshouse" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Прокрутка к началу" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/ru/">Что такое StatsHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/ru/quick-start">Краткое руководство</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/statshouse/ru/guides/access-cluster">Пользователям</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/statshouse/ru/admin/sys-req">Администраторам</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/statshouse/ru/overview/features">Обзор</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/ru/overview/features">Преимущества</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/statshouse/ru/overview/concepts">Основные понятия</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/statshouse/ru/overview/components">Компоненты</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/statshouse/ru/support">Поддержка</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Навигационная цепочка текущей страницы"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Главная страница" class="breadcrumbs__link" href="/statshouse/ru/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Обзор</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Компоненты</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Содержание этой страницы</button></div><div class="theme-doc-markdown markdown"><h1>Компоненты</h1>
<p>Основные компоненты StatsHouse изображены на рисунке:</p>
<img src="/statshouse/ru/assets/images/components-91a7e70e1abfb6ae828f099df6ad4d49.png" width="1000">
<p>А вот их описания:</p>
<ul>
<li><a href="/statshouse/ru/overview/components#%D0%B0%D0%B3%D0%B5%D0%BD%D1%82">Агент</a>
<ul>
<li><a href="/statshouse/ru/overview/components#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85-%D0%BF%D0%BE-udp">Получение данных UDP</a></li>
<li><a href="/statshouse/ru/overview/components#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B0%D0%B3%D0%B5%D0%BD%D1%82%D0%BE%D0%B2-%D0%B2-%D0%BF%D0%BE%D0%B4%D0%B0%D1%85-kubernetes">Установка агентов в подах Kubernetes</a></li>
</ul>
</li>
<li><a href="/statshouse/ru/overview/components#%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%82%D0%BE%D1%80">Агрегатор</a>
<ul>
<li><a href="/statshouse/ru/overview/components#%D0%B0%D0%BA%D1%82%D1%83%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B8-%D0%B8%D1%81%D1%82%D0%BE%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5">Актуальные и &quot;исторические&quot; данные</a></li>
<li><a href="/statshouse/ru/overview/components#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D0%BF%D1%80%D0%B8-%D0%BE%D1%82%D0%BA%D0%B0%D0%B7%D0%B5-%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%82%D0%BE%D1%80%D0%B0">Работа при отказе агрегатора</a></li>
</ul>
</li>
<li><a href="/statshouse/ru/overview/components#%D0%B1%D0%B0%D0%B7%D0%B0-%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85">База данных</a></li>
<li><a href="/statshouse/ru/overview/components#api">API</a></li>
<li><a href="/statshouse/ru/overview/components#%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D1%81%D0%BA%D0%B8%D0%B9-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81-ui">Пользовательский интерфейс (UI)</a></li>
<li><a href="/statshouse/ru/overview/components#%D0%BF%D1%80%D0%BE%D0%BA%D1%81%D0%B8">Прокси</a></li>
<li><a href="/statshouse/ru/overview/components#%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81-%D0%BC%D0%B5%D1%82%D0%B0%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85">Сервис метаданных</a>
<ul>
<li><a href="/statshouse/ru/overview/components#%D0%B1%D1%8E%D0%B4%D0%B6%D0%B5%D1%82-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B9-%D1%82%D0%B5%D0%B3%D0%BE%D0%B2">Бюджет на создание значений тегов</a>
<ul>
<li><a href="/statshouse/ru/overview/components#%D1%82%D0%B5%D0%B3-string-top-%D1%82%D0%BE%D0%BF-%D1%81%D1%82%D1%80%D0%BE%D0%BA"><em>Тег String top</em> (Топ строк)</a></li>
<li><a href="/statshouse/ru/overview/components#%D1%81%D1%8B%D1%80%D1%8B%D0%B5-raw-%D1%82%D0%B5%D0%B3%D0%B8">&quot;Сырые&quot; (<em>Raw</em>) теги</a></li>
</ul>
</li>
<li><a href="/statshouse/ru/overview/components#%D0%B1%D1%8E%D0%B4%D0%B6%D0%B5%D1%82-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA">Бюджет на создание метрик</a></li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="агент">Агент<a class="hash-link" aria-label="Прямая ссылка на Агент" title="Прямая ссылка на Агент" href="/statshouse/ru/overview/components#агент">​</a></h2>
<p>Агент</p>
<ul>
<li>валидирует метрику (например, проверяет, существует ли она),</li>
<li><a href="/statshouse/ru/overview/concepts#%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%86%D0%B8%D1%8F">агрегирует</a> данные в пределах секунды,</li>
<li>шардирует данные</li>
<li>и отправляет их на агрегаторы.</li>
</ul>
<img src="/statshouse/ru/assets/images/agent-2b52ee89860a5ea30deee612bc707b4a.png" width="500">
<p>Если агрегаторы недоступны, агент хранит данные на локальном диске в пределах квоты и отправляет их позже.</p>
<p>An agent receives metric data via <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank" rel="noopener noreferrer">UDP</a>. Supported formats are</p>
<ul>
<li><a href="https://www.json.org/json-en.html" target="_blank" rel="noopener noreferrer">JSON</a>,</li>
<li><a href="https://protobuf.dev" target="_blank" rel="noopener noreferrer">Protocol Buffers</a>,</li>
<li><a href="https://msgpack.org" target="_blank" rel="noopener noreferrer">MessagePack</a>,</li>
<li><a href="https://core.telegram.org/mtproto/TL" target="_blank" rel="noopener noreferrer">TL</a>.</li>
</ul>
<p>Агент получает данные по протоколу <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol" target="_blank" rel="noopener noreferrer">UDP</a>. Поддерживаются
следующие форматы:</p>
<ul>
<li><a href="https://www.json.org/json-en.html" target="_blank" rel="noopener noreferrer">JSON</a>,</li>
<li><a href="https://protobuf.dev" target="_blank" rel="noopener noreferrer">Protocol Buffers</a>,</li>
<li><a href="https://msgpack.org" target="_blank" rel="noopener noreferrer">MessagePack</a>,</li>
<li><a href="https://core.telegram.org/mtproto/TL" target="_blank" rel="noopener noreferrer">TL</a>.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Агенты поддерживают IPv6.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="получение-данных-по-udp">Получение данных по UDP<a class="hash-link" aria-label="Прямая ссылка на Получение данных по UDP" title="Прямая ссылка на Получение данных по UDP" href="/statshouse/ru/overview/components#получение-данных-по-udp">​</a></h3>
<p>StatsHouse receives data via UDP in the MessagePack, Protocol Buffers, JSON, and TL formats—they are semantically
identical. It automatically detects the format by the first bytes in the packet.</p>
<p>StatsHouse получает данные по UDP в форматах MessagePack, Protocol Buffers, JSON и TL — они семантически
идентичны. Формат определяется автоматически по первым байтам в пакете.</p>
<p>Посмотрите схемы для <a href="https://github.com/VKCOM/statshouse/blob/master/internal/data_model/public.tl" target="_blank" rel="noopener noreferrer">TL</a>,
MessagePack и <a href="https://github.com/VKCOM/statshouse/blob/master/internal/receiver/statshouse.proto" target="_blank" rel="noopener noreferrer">Protocol Buffers</a>:</p>
<div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">TL</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">MessagePack</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Protocol Buffers</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">---types---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">statshouse.metric#3325d884 fields_mask:#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name:    string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags:    (dictionary string)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">counter: fields_mask.0?double</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ts:      fields_mask.4?#               // UNIX timestamp UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value:   fields_mask.1?(vector double)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unique:  fields_mask.2?(vector long)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">= statshouse.Metric;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---functions---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth JSON interoperability, first byte of tag must not be 0x5b or 0x7b (&quot;[&quot; or &quot;{&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth MessagePack interoperability, first byte of tag must be less than 0x80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// for smooth ProtoBuf interoperability, first byte must be as large as possible.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@write statshouse.addMetricsBatch#56580239 fields_mask:# metrics:(vector statshouse.metric) = True;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="language-{ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-{ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  metrics: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ts:   1670673392,     # uint32, UNIX timestamp in seconds (optional)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      name: &quot;foobar&quot;,       # string([a-zA-Z][a-zA-Z0-9_]*), metric name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      tags: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;env&quot;:              # string([a-zA-Z][a-zA-Z0-9_]*), tag name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;production&quot;      # string(printable UTF-8),       tag value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      counter: 100500.1,    # float64,        number of observed events</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      value:   [0.7],       # array(float64), observed values array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      unique:  [591068825], # array(int64),   observed IDs array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package statshouse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">option go_package = &quot;github.com/vkcom/statshouse/internal/receiver/pb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message Metric {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string              name    = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    map&lt;string, string&gt; tags    = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    double              counter = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint32              ts      = 4;  // UNIX seconds UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated double     value   = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated int64      unique  = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message MetricBatch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    repeated Metric metrics = 13337;  // to autodetect packet format by first bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// to compile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// sudo apt-get install libprotobuf-dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// go install google.golang.org/protobuf/cmd/protoc-gen-go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ~/go/src/github.com/vkcom/statshouse$ protoc -I=internal/receiver --go_out=../../../../.. statshouse.proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// to compile if proto3 format not supported, for example by protocute</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 1. comment out line: option go_package = &quot;github.com/vkcom/statshouse/internal/receiver/pb&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. add</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// message MapFieldEntry {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   optional string key = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   optional string value = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. replace Metric with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// message Metric {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// string              name    = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// map&lt;string, string&gt; tags    = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// double              counter = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// uint32              ts      = 4;  // UNIX seconds UTC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// repeated double     value   = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// repeated int64      unique  = 6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. ./protocute --cpp_out=. ~/go/src/github.com/vkcom/statshouse/internal/receiver/statshouse.proto</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></div>
<p>Пакет — это объект, содержащий массив метрик:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    {&quot;metrics&quot;:[ ... ]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Каждый элемент этого массива представляет собой объект с полями:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;name&quot;:&quot;rpc_call_latency&quot;,  // metric name (obligatory)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;tcp&quot;}, // tags</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;ts&quot;: 1630000000,           // timestamp; 0 and no timestamp means &quot;now&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 6,               // event counter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;value&quot;: [1, 2.0, -3.0],    // values if any (do not use with &quot;unique&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;unique&quot;: [15, 18, -60]     // unique counters if any (do not use with &quot;value&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Например, можно отправить такой пакет:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;:&quot;rpc_call_latency&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;tcp&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;value&quot;: [15, 18, 60]},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;: &quot;rpc_call_errors&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;protocol&quot;: &quot;udp&quot;,&quot;error_code&quot;: &quot;-3000&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 5}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;metrics&quot;:[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{&quot;name&quot;: &quot;external_landings&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;tags&quot;:{&quot;country&quot;: &quot;ru&quot;,&quot;gender&quot;: &quot;m&quot;,&quot;skey&quot;: &quot;lenta.ru&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> &quot;counter&quot;: 1}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Обратите внимание на требования к использованию форматов.</p>
<ul>
<li>Для TL: тело пакета должно быть Boxed-сериализацией объекта <code>statshouse.addMetricsBatch</code>.</li>
<li>Для JSON: первым символом должна быть фигурная скобка <code>{</code> (для корректного определения формата).</li>
<li>Для Protocol Buffers: не добавляйте поля в объект <code>MetricBatch</code> (для корректного определения формата).</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="установка-агентов-в-подах-kubernetes">Установка агентов в подах Kubernetes<a class="hash-link" aria-label="Прямая ссылка на Установка агентов в подах Kubernetes" title="Прямая ссылка на Установка агентов в подах Kubernetes" href="/statshouse/ru/overview/components#установка-агентов-в-подах-kubernetes">​</a></h3>
<p>Не устанавливайте агенты в подах Kubernetes.
Мы настоятельно рекомендуем устанавливать их только на реальных серверах (обязательно указывайте порт <code>13337</code>).</p>
<p>Число агентов не должно колебаться.
Агенты отправляют агрегаторам посекундные отчёты. Если число агентов постоянно, значит, они подключены к
агрегаторам. Из-за остановки подов число агентов уменьшается, и срабатывает главный алерт StatsHouse.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p>При шифровании в VK RPC для вывода эфемерных ключей используются удалённый и локальный IP-адреса соединений (как их
видят клиент и сервер).
Маршрутизация пакетов от одного адаптера к другому через брандмауэр делает установление соединений невозможным.
Для соединения компонентов в таком случае понадобится создать виртуальные сетевые адаптеры и соединить
их средствами Linux network namespaces.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="агрегатор">Агрегатор<a class="hash-link" aria-label="Прямая ссылка на Агрегатор" title="Прямая ссылка на Агрегатор" href="/statshouse/ru/overview/components#агрегатор">​</a></h2>
<p>Агрегирует посекундные данные от всех агентов и вставляет результат в базу данных ClickHouse.</p>
<img src="/statshouse/ru/assets/images/aggregator-a14cccc8b6f4553a710273af7dc5abde.png" width="500">
<p>Число агрегаторов должно быть равно числу шардов ClickHouse с репликами. Каждый агрегатор вставляет
данные в реплику базы данных, развёрнутую на той же машине. Например: 3 шарда × 3 реплики = 9 агрегаторов.</p>
<img src="/statshouse/ru/assets/images/shards-replicas-475e10fbe68f8cda26316cb0ede8076d.png" width="700">
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="актуальные-и-исторические-данные">Актуальные и &quot;исторические&quot; данные<a class="hash-link" aria-label="Прямая ссылка на Актуальные и &quot;исторические&quot; данные" title="Прямая ссылка на Актуальные и &quot;исторические&quot; данные" href="/statshouse/ru/overview/components#актуальные-и-исторические-данные">​</a></h3>
<p>У агрегатора есть два режима работы:</p>
<ul>
<li>работа с актуальными  данными,</li>
<li>работа с &quot;историческими&quot; данными. Данные считаются &quot;историческими&quot;, если их не удалось отправить сразу после создания.</li>
</ul>
<p>Вставка актуальных данных — приоритет для агрегатора.</p>
<img src="/statshouse/ru/assets/images/real-hist-bc7cebbb031517a8477b2c88aa11865a.png" width="800">
<p>Представьте: возник сбой. Долгое время вставить данные было невозможно, затем система восстановилась.
StatsHouse немедленно начинает вставлять актуальные данные. А вот &quot;исторические&quot; данные StatsHouse вставит при
первой возможности, если только это не помешает вставке актуальных данных.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p>Вставка актуальных данных имеет приоритет, поскольку &quot;исторические&quot; данные вставляются в базу ClickHouse
довольно медленно.</p><p><strong>Актуальные данные</strong></p><p>Агрегатор позволяет агентам вставлять данные за последние 5 минут — это &quot;короткое&quot; окно вставки (его можно
настроить). Если агент не успел вставить данные вовремя, он отправит данные как &quot;исторические&quot;.</p><p>Для каждой актуальной секунды агрегатор хранит контейнер со статистикой. В этот контейнер агрегирую тся данные от
агентов. Как только наступает следующая секунда, агрегатор вставляет данные для неё (из &quot;короткого&quot; окна)
в базу. А агенты получают ответ с результатом вставки.</p><p>&quot;Короткое&quot; окно распространяется на две секунды в будущее, чтобы нормально работали агенты, у которых часы немного
спешат.</p><p><strong>&quot;Исторические&quot; данные</strong></p><p>Агрегатор позволяет агентам вставлять данные за последние 48 часов — это &quot;длинное&quot; окно вставки (его можно
настроить).</p><p>Если данные старше 48 часов, StatsHouse записывает метастатистику и выбрасывает этот фрагмент данных. Агент получает ответ <code>OK</code>.</p><p>Агрегация между хостами очень важна, поэтому StatsHouse делает всё возможное, чтобы она состоялась:
</p><li>каждый агент делает запрос на вставку нескольких десятков &quot;исторических&quot; секунд, начиная с самой &quot;старой&quot;;</li>
<li>агрегатор получает эти запросы и выбирает самую &quot;старую&quot; секунду;</li>
<li>он агрегирует данные, вставляет их в базу данных и отправляет ответ;</li>
<li>затем снова выбирает &quot;самую старую&quot; секунду и т.д.</li><p></p><p>Этот алгоритм помогает наиболее удалённым (&quot;старым&quot;) секундам оказаться рядом с самыми &quot;новыми&quot;. Он делает
возможным агрегирование исторических данных и помогает вставлять данные одновременно.</p></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="работа-при-отказе-агрегатора">Работа при отказе агрегатора<a class="hash-link" aria-label="Прямая ссылка на Работа при отказе агрегатора" title="Прямая ссылка на Работа при отказе агрегатора" href="/statshouse/ru/overview/components#работа-при-отказе-агрегатора">​</a></h3>
<p>Если агрегатор недоступен или отвечает с ошибкой, агент хранит данные на локальном диске.
Хранение данных на диске ограничено в байтах. Оно также ограничено по времени — в пределах &quot;длинного&quot;
(48-часового) окна вставки.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p><strong>Распределение данных между репликами</strong></p><p>Если доступ к диску нежелателен или невозможен, можно запустить агент с пустым аргументом <code>--cache-dir</code>.
StatsHouse не будет использовать диск. &quot;Исторические&quot; данные будут храниться в памяти, пока агрегаторы
недоступны, т. е. в течение нескольких минут.</p><p>Если агрегатор недоступен, агенты отправляют данные репликам.
Данные распределяются в соответствии с порядковыми номерами секунд: чётные секунды отправляются в одну из реплик,
нечётные — в другую. Таким образом, нагрузка на обе реплики увеличивается на 50 %. Это одна из причин, по которой
StatsHouse записывает данные ровно в три реплики ClickHouse.</p><p><strong>Предотвращение двойной вставки</strong></p><p>Если агрегатор отвечает с ошибкой, агент отправляет данные другому агрегатору (другой реплике) на другом
хосте. Для дедупликации нужно использовать алгоритм консенсуса, а это довольно сложно.</p><p>В StatsHouse основной и резервный агрегаторы могут вставлять данные от одного и того же агента в одну и ту же секунду.
Это происходит редко, и для такого случая мы отслеживаем двойные вставки с помощью метаметрики <code>__heartbeat_version</code>,
которая показывает <em>количество агентов, отправляющих данные в текущую секунду</em>. Чтобы эта метаметрика была
стабильной при нормальной работе агрегаторов, агенты отправляют данные каждую секунду, даже если в данный момент нет
реальных пользовательских данных.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="база-данных">База данных<a class="hash-link" aria-label="Прямая ссылка на База данных" title="Прямая ссылка на База данных" href="/statshouse/ru/overview/components#база-данных">​</a></h2>
<p>В базе данных <a href="https://clickhouse.com" target="_blank" rel="noopener noreferrer">ClickHouse</a> хранятся <a href="/statshouse/ru/overview/concepts#%D0%B0%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%86%D0%B8%D1%8F">агрегированные</a> данные метрик.</p>
<p>StatsHouse вставляет данные в таблицу ClickHouse, которая определяется следущим образом:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE statshouse2_value_1s (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `time`           DateTime,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `metric`         Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag0`           Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag1`           Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `tag15`          Int32,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `stag`           String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `count`          SimpleAggregateFunction(sum, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `min`            SimpleAggregateFunction(min, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `max`            SimpleAggregateFunction(max, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `sum`            SimpleAggregateFunction(sum, Float64),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `max_host`       AggregateFunction(argMax, Int32, Float32), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `percentiles`    AggregateFunction(quantilesTDigest(0.5), Float32),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `uniq_state`     AggregateFunction(uniq, Int64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = *MergeTree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY toDate(time) ORDER BY (metric, time,tag0,tag1, ...,tag15, stag);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Если для метрики не включена запись <a href="/statshouse/ru/guides/edit-metrics#percentiles">перцентилей</a> или метрика не имеет тип
<a href="/statshouse/ru/guides/design-metric#unique-counters"><em>unique counter</em></a>, соответствующие столбцы таблицы (<code>percentiles</code> или
<code>uniq_state</code>) будут пустыми.</p>
<p>Если метрика представляет собой простой <a href="/statshouse/ru/guides/design-metric#counters">счётчик</a>, все столбцы будут пустыми,
кроме <code>count</code>.  Колонка <code>stag</code> не пуста, только если в метрике используется
<a href="/statshouse/ru/guides/design-metric#string-top-tag">тег String top</a>.</p>
<p>Чтобы получить данные за интервал, превышающий секунду, StatsHouse агрегирует данные и создает поминутные
и часовые агрегаты.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p>Данные распределяются между шардами ClickHouse с помощью хэша <code>metric, key0, ... , key15</code>.
Если в метрике используется несколько тегов, то данные, относящиеся к конкретному тегу (например, <code>&quot;protocol&quot;:  &quot;tcp&quot;</code>), обычно хранятся на разных шардах. Чтобы получить полную статистику, всегда нужно делать <em>распределённые
запросы</em> ко всему набору шардов.</p><p>Почему это так?
Набор значений тегов имеет определенную кардинальность: существует конечное число возможных комбинаций значений тегов для
метрики. Если мы достигаем предела кардинальности, то есть отправляем все эти комбинации значений те гов,
объём данных перестает увеличиваться из-за агрегации — StatsHouse объединяет события с одним и тем же сочетанием
значений тегов.</p><p>Чтобы хранить выборку данных для всей метрики, каждый шард должен хранить столько рядов, сколько существует
комбинаций значений тегов для метрики, а не долю, пропорциональную числу шардов.</p><p>StatsHouse не использует буферные таблицы: каждый агрегатор вставляет данные раз в секунду в
incoming-таблицу. Данные фильтруются по <code>time</code> в пределах окна приёма (48 часов) и копируются через
материализованное представление. Это защищает StatsHouse от вставки &quot;мусорных&quot; данных. В противном случае
ClickHouse должен был бы читать данные не из одного или двух шардов, а из всех.</p><p>Шард должен иметь три или более реплик. Агрегаторы вставляют данные в первые три реплики.
Остальные являются read-only репликами — их можно использовать, чтобы масштабировать нагрузку на чтение.</p><p>Количество шардов может быть любым. Для предотвращения неправильной конфигурации и непоследовательного
шардирования, которое может привести к резкому увеличению объёма данных из-за слабой агрегации, агенты отправляют
агрегатору номер реплики шарда. Если агрегатор &quot;видит&quot;, что данные предназначаются не ему, то отвечает ошибкой.
Этот же номер позволяет прокси направить данные нужному агрегатору.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="api">API<a class="hash-link" aria-label="Прямая ссылка на API" title="Прямая ссылка на API" href="/statshouse/ru/overview/components#api">​</a></h2>
<p>Ознакомьтесь со спецификацией <a href="/statshouse/ru/guides/openapi">OpenAPI</a> для StatsHouse.</p>
<p>Тонкий API-клиент позволяет StatsHouse отправлять эффективные запросы к базе данных.
Сервис кэширует данные, чтобы минимизировать нагрузку на базу данных. Мы ограничиваем получение данных
непосредственно из ClickHouse, поскольку неэффективные запросы могут негативно повлиять на кластер ClickHouse.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="пользовательский-интерфейс-ui">Пользовательский интерфейс (UI)<a class="hash-link" aria-label="Прямая ссылка на Пользовательский интерфейс (UI)" title="Прямая ссылка на Пользовательский интерфейс (UI)" href="/statshouse/ru/overview/components#пользовательский-интерфейс-ui">​</a></h2>
<p>Пользовательский интерфейс получает данные из StatsHouse API и отображает данные метрик в виде графика.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="прокси">Прокси<a class="hash-link" aria-label="Прямая ссылка на Прокси" title="Прямая ссылка на Прокси" href="/statshouse/ru/overview/components#прокси">​</a></h2>
<p>Прокси получает данные от агентов, которые находятся за пределами защищённого периметра
(т.е. за пределами датацентра) и отправляет их в агрегаторы.</p>
<p>Агенты и агрегаторы используют протокол TL/RPC с ключом шифрования датацентра. Таким образом, агенты, находящиеся за
пределами датацентра, не могут подключаться к агрегаторам напрямую, поскольку это требовало бы раскрытия или
копирования ключа для внешних систем.</p>
<p>Для внешних подключений у прокси есть отдельный набор ключей шифрования. Чтобы отозвать ключ шифрования,
необходимо удалить его из конфигурации прокси.</p>
<p>Проекси не имеет состояния. Чтобы снизить вероятность атаки, он проксирует только подмножество TL/RPC
типов запросов, используемых агрегаторами.</p>
<p>Требуется ровно три прокси. Каждый из них является прокси для соответствующей реплики шарда.
Недоступный прокси эквивалентен выходу из строя реплики одного шарда и не влияет на работу StatsHouse.</p>
<img src="/statshouse/ru/assets/images/ingress-proxy-84f922c34ded3524048637ae15c26af5.png" width="600">
<p>Три экземпляра прокси имитируют агрегаторы. Можно устано вить ещё один уровень проксирования за имеющимися
прокси. Этот уровень будет использовать предыдущие прокси в качестве агрегаторов.</p>
<p>Не рекомендуется устанавливать прокси в подах Kubernetes.</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p><strong>Криптоключи</strong></p><p>StatsHouse использует протокол VK RPC с (опциональным) шифрованием для общения компонентов.</p><p>Согласно протоколу VK RPC криптоключ является одновременно логином для получения доступа и секретом для получения
эфемерных ключей соединения. Чтобы установить соединение, клиент должен использовать один из ключей, известных серверу.
Центральным компонентом системы являются агрегаторы. При запуске они получают единственный &quot;главный&quot; криптоключ
датацентра.</p><p>Для подключения к агрегаторам агенты должны получить следующие параметры:
</p><li><code>-agg-addr</code> — адреса первого шарда агрегаторов;</li>
<li><code>-aes-pwd-file</code> — &quot;главный&quot; криптоключ датацентра.</li><p></p><p>Описанный механизм безопасен только внутри защищённого периметра. Для подключения извне используйте прокси,
установленный на границе.</p><p>Прокси, стоящий на границе, состоит из двух частей:
</p><li>RPC-сервера для подключения агентов извне,</li>
<li>RPC-клиента для подключения самого прокси к агрегаторам внутри периметра.</li><p></p><p>Для прокси необходимо настроить следующие параметры:
</p><li><code>-ingress-external-addr</code> — внешние адреса прокси-серверов, которые агенты используют для подключения;</li>
<li><code>-ingress-addr</code> — параметр для управления интерфейсами, на которые подключаются агенты;</li>
<li><code>-aes-pwd-file</code> — внутренний криптоключ для отправки данных агрегаторам;</li>
<li><code>-ingress-pwd-dir</code> — набор внешних ключей для агентов с удаленных площадок.</li><p></p><p>Параметр <code>-ingress-addr</code> обычно имеет значение <code>:8128</code>, что равнозначно <code>0.0.0.0:8128</code>.
Он также может содержать адрес подсети сетевого адаптера, чтобы разрешить подключение только через него. Порт в
параметре <code>-ingress-addr</code> должен совпадать с одним из портов в параметре <code>-ingress-external-addr</code>. &quot;Внешняя&quot; часть
входящего прокси должна быть доступна агентам через эти порты.</p><p>Каждый из этих файлов содержит криптоключ; имя файла игнорируется и считается комментарием. Ключи имеют
произвольную длину — не менее четырех байт. Первые четыре байта служат для идентификации ключа, поэтому
они не должны быть одинаковыми.</p><p>Если внешние ключи в папке изменились, перезапустите прокси. Прокси не следит за этой папкой, так как набор
ключей меняются редко.</p><p>Каждый агент получает один из ключей, указанных у прокси в папке <code>-ingress-pwd-dir</code>, в качестве
параметра <code>-aes-pwd-file</code>.</p></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="сервис-метаданных">Сервис метаданных<a class="hash-link" aria-label="Прямая ссылка на Сервис метаданных" title="Прямая ссылка на Сервис метаданных" href="/statshouse/ru/overview/components#сервис-метаданных">​</a></h2>
<p>Сервис метаданных хранит глобальный маппинг <code>string</code>↔<code>int32</code>: именно здесь имена метрик и значения тегов,
которые являются строками, отображаются в целые числа.</p>
<p>StatsHouse предоставляет данные в режиме реального времени. Чтобы гарантировать минимальную
задержку, StatsHouse отображает строковые значения тегов (а также названия метрик) в <code>int32</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;iphone&#x27; &lt;=&gt; 12</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &#x27;null&#x27; &lt;=&gt; 26</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Скопировать в буфер обмена" title="Скопировать" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Этот огромный маппинг общий для всех метрик. Элементы маппинга никогда не удаляются.</p>
<p>Чтобы не допустить неконтролируемого увеличения маппинга, бюджеты на
<a href="/statshouse/ru/overview/components#%D0%B1%D1%8E%D0%B4%D0%B6%D0%B5%D1%82-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA">создание метрик</a> и <a href="/statshouse/ru/overview/components#%D0%B1%D1%8E%D0%B4%D0%B6%D0%B5%D1%82-%D0%BD%D0%B0-%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B9-%D1%82%D0%B5%D0%B3%D0%BE%D0%B2">значений тегов</a> ограничены.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="бюджет-на-создание-значений-тегов">Бюджет на создание значений тегов<a class="hash-link" aria-label="Прямая ссылка на Бюджет на создание значений тегов" title="Прямая ссылка на Бюджет на создание значений тегов" href="/statshouse/ru/overview/components#бюджет-на-создание-значений-тегов">​</a></h3>
<p>Чтобы предотвратить неконтролируемый рост маппинга <code>string</code>↔<code>int32</code>, мы ограничиваем бюджет на создание значений
тегов до 300 в день. Если бюджет исчерпан, новые строки (значения тегов) можно добавлять в маппинг дважды в час
(правило настраивается).</p>
<p>При превышении бюджета возникают ошибки типа <strong>Mapping flood</strong>. Когда бюджет исчерпан и добавлять новые строки в
маппинг нельзя, StatsHouse вставляет значение <code>mapping flood</code> в колонку тега, чтобы не потерять событие целиком.</p>
<p>Чтобы создавать <a href="/statshouse/ru/guides/design-metric#how-many-tag-values">теги с большим количеством разных значений</a>, но
избежать ошибок <code>mapping flood</code>, можно использовать тег
<a href="/statshouse/ru/guides/design-metric#string-top-tag">String top (Топ строк)</a> и
<a href="/statshouse/ru/guides/design-metric#raw-tags">Raw</a> теги (теги с &quot;сырыми&quot; значениями).</p>
<img src="/statshouse/ru/assets/images/mapping-6cd5a4098b656c6e86b2617a4eff7558.png" width="600">
<p>Если вам нужны теги с большим количеством 32-битных чисел (например, тег <code>user_ID</code>),
используйте <a href="/statshouse/ru/guides/design-metric#raw-tags">Raw</a> теги, чтобы избежать ошибок <code>mapping flood</code>.</p>
<p>Если вам нужен тег с разнообразными строковыми значениями (например, тег <code>search_request</code>), используйте
тег <a href="/statshouse/ru/overview/components#%D1%82%D0%B5%D0%B3-string-top-%D1%82%D0%BE%D0%BF-%D1%81%D1%82%D1%80%D0%BE%D0%BA">String top (Топ строк)</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="тег-string-top-топ-строк">Тег String top (Топ строк)<a class="hash-link" aria-label="Прямая ссылка на Тег String top (Топ строк)" title="Прямая ссылка на Тег String top (Топ строк)" href="/statshouse/ru/overview/components#тег-string-top-топ-строк">​</a></h4>
<p>Тег <em>String top</em> отличается от других тем, что его значения <em>не добавляются в маппинг <code>string</code>↔<code>int32</code></em>. Это отдельный
столбец <code>tag_s</code> в таблице ClickHouse:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_packets_size</td><td>JSON<br><text class="orange-text">mapped to <code>int32</code></text></td><td>ok<br><text class="orange-text">mapped to <code>int32</code></text></td><td>my-tag-value<br><text class="orange-text">NOT mapped to <code>int32</code></text></td><td>100</td><td>1300</td><td>20</td><td>1200</td></tr></tbody></table>
<p>Поскольку строки, не добавленные в маппинг, занимают много места и дольше читаются, StatsHouse ограничивает их
количество (например, до сотни). Это ограничение настраивать нельзя. Что же происходит с остальными
строками, не поместившимися в эту сотню?</p>
<div class="theme-admonition theme-admonition-important admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</div><div class="admonitionContent_BuS1"><p>StatsHouse сохраняет только строки с наиболее часто используемыми значениями тега <em>String top</em> — строки с наибольшим
<em>счётчиком</em>. Остальные значения тега <em>String top</em> превращаются в <em>empty</em> и агрегируются.</p></div></div>
<p>Как это работает? Посмотрим на примере.
Представим, что ограничение на тег <em>String top</em> равно не сотне, а четырём. А данные для нашей метрики выглядят так:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_mextric</td><td>...</td><td>...</td><td>b</td><td>3</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>Приходят новые данные: строка со значением тега <em>String top</em>, равным <code>e</code>, и счётчиком, равным <code>55</code>.
Механизм <em>String top</em> выбирает значение тега с наименьшим счётчиком (<code>b</code> — менее популярный) и превращает его в
<em>empty</em>:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>b</strong> → <em>empty string</em></td><td><strong>3</strong></td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>e</strong></td><td><strong>55</strong></td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>Затем добавляется строка со значением <code>f</code> в теге и счётчиком, равным <code>2</code>.</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><em>empty string</em></td><td>3</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>e</td><td>55</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><strong>f</strong> → <em>empty string</em></td><td><strong>2</strong></td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<p>Поскольку значение <code>f</code> используется редко (значение счётчика меньше, чем у других), оно тоже превращается в
<em>empty</em> и агрегируется с предыдущей пустой строкой:</p>
<table><thead><tr><th>timestamp</th><th>metric</th><th>tag_1</th><th>tag_2</th><th><text class="orange-text">tag_s</text></th><th>counter</th><th>sum</th><th>min</th><th>max</th></tr></thead><tbody><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>a</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td><em>empty string</em></td><td><strong>3+2</strong></td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>c</td><td>100</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>d</td><td>88</td><td>...</td><td>...</td><td>...</td></tr><tr><td>13:45:05</td><td>toy_metric</td><td>...</td><td>...</td><td>e</td><td>55</td><td>...</td><td>...</td><td>...</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="сырые-raw-теги">&quot;Сырые&quot; (<em>Raw</em>) теги<a class="hash-link" aria-label="Прямая ссылка на сырые-raw-теги" title="Прямая ссылка на сырые-raw-теги" href="/statshouse/ru/overview/components#сырые-raw-теги">​</a></h4>
<p>Если значения тегов изначально являются 32-битными числами, вы можете пометить их как &quot;сырые&quot; (<em>Raw</em>),
чтобы избежать переполнения маппинга.
Такие значения тегов (<em>Raw</em>) StatsHouse будет воспринимать как <code>(u)int32</code> (возможные значения: <code>-2^31..2^32-1</code>)
и вставлять в базу ClickHouse, не добавляя в маппинг.
Узнайте, как <a href="/statshouse/ru/guides/edit-metrics#set-up-raw-tags">настроить &quot;сырые&quot; (<em>Raw</em>) теги</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="бюджет-на-создание-метрик">Бюджет на создание метрик<a class="hash-link" aria-label="Прямая ссылка на Бюджет на создание метрик" title="Прямая ссылка на Бюджет на создание метрик" href="/statshouse/ru/overview/components#бюджет-на-создание-метрик">​</a></h3>
<p>Пользователи могут создавать сколько угодно метрик — вручную через пользовательский интерфейс StatsHouse.
Как правило, автоматизировать создание метрик нельзя.</p>
<p>StatsHouse предполагает, что метрик не так много: сотни тысяч. Система не защищёна от
неконтролируемого роста числа метрик.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Если вы переходите на StatsHouse с другой системы мониторинга, обратитесь к администраторам StatsHouse в вашей
организации, чтобы включить режим автосоздания (по завершении миграции его нужно отключить).</p></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Подробнее</summary><div><div class="collapsibleContent_i85q"><p><strong>Получение свойств метрики из сервиса метаданных</strong></p><p>Агрегаторы получают содержание маппинга непосредственно от сервиса метаданных. Агенты работают с маппингом через
агрегаторы. И агенты, и агрегаторы кэшируют содержимое маппинга в памяти или файле и хранят в течение месяца.</p><p>При первом запуске агенты используют специальный bootstrap-запрос, чтобы получить 100 000 наиболее часто
используемых строк из маппинга. В противном случае при развертывании большого количества агентов
StatsHouse должен был бы загрузить огромное чилос значений одно за другим. Это заняло бы много времени, в течение
которого StatsHouse не мог бы записывать данные.</p><p>Агрегаторы используют TL/RPC long polling для получения информации о метриках из сервиса метаданных. Агенты
используют long polling для получения информации от агрегаторов. Таким образом, все агенты получают
информацию об изменениях в свойствах метрик практически мгновенно (за секунду).</p><p><strong>Удаление метрик</strong></p><p>Удалить метрику нельзя, потому что в базе данных ClickHouse нет эффективного способа сделать это.
StatsHouse использует флаг <code>visible</code> для отключения метрики, т.е. для скрытия метрики из списка метрик
(это действие обратимо). Отключение метрики прекращает запись данных для нее в базу данных.</p></div></div></details></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Страница документа"><a class="pagination-nav__link pagination-nav__link--prev" href="/statshouse/ru/overview/concepts"><div class="pagination-nav__sublabel">Предыдущая страница</div><div class="pagination-nav__label">Основные понятия</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/statshouse/ru/support"><div class="pagination-nav__sublabel">Следующая страница</div><div class="pagination-nav__label">Поддержка</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#агент">Агент</a><ul><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#получение-данных-по-udp">Получение данных по UDP</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#установка-агентов-в-подах-kubernetes">Установка агентов в подах Kubernetes</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#агрегатор">Агрегатор</a><ul><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#актуальные-и-исторические-данные">Актуальные и &quot;исторические&quot; данные</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#работа-при-отказе-агрегатора">Работа при отказе агрегатора</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#база-данных">База данных</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#api">API</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#пользовательский-интерфейс-ui">Пользовательский интерфейс (UI)</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#прокси">Прокси</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#сервис-метаданных">Сервис метаданных</a><ul><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#бюджет-на-создание-значений-тегов">Бюджет на создание значений тегов</a></li><li><a class="table-of-contents__link toc-highlight" href="/statshouse/ru/overview/components#бюджет-на-создание-метрик">Бюджет на создание метрик</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">© StatsHouse, 2024 г.</div></div></div></footer></div>
</body>
</html>