# sqlitev2

## Отличия от версии 1:

1. Транзакции могут терять данные
2. Все write операции не требующие бинлога нужно делать до вызова Run


## Особенности реализации:

### Термины

- `wal` - файл со страницами базы, каждый раз когда транзакция хочет поменять страницы базы она пишет ее в этот файл
- `checkpoint` - операция переноса страниц wal'а в файл базы
- `wal2 режим` - режим работы sqlite в котором используются 2 wal файла. Это позволяет избежать бесконечного роста wal файла ([подробнее](https://www.sqlite.org/cgi/src/doc/wal2/doc/wal2.md))
- `wal switch` - операция переключения текущего wal'a. После ее выполнения все послеющии страницы будут записываться в новый wal файл
- `бинлог`/`барсик`/`коммит`/`реверт`/... - ?

### -

- Коммит в sqlite происходит сразу после применения операций пользователя. Это требуется чтобы View операции могли видеть изменения
- `DoTx` завершается сразу после коммита в sqlite. Ожидание коммита барсика не происходит (будет добавлена такая возможность позже)
- В связи с пунктом `1` требуется уметь откатывать транзакции sqlite, так как барсик может запросить revert.
  
Для выполнения операции revert используется следующая схема

- Создается отдельный файл в котором хранится позиция последнего барсик коммита
- Во время wal switch, в памяти запоминается позиция бинлог оффсета которому соответствует старый wal
- Checkpoint происходит мануально только после того как коммит позиция барсика будет больше или равна позиции старого wal'а И в новом wal есть хотя бы один коммит

Рестарт:

- Если у базы нет wal'ов просто стартуем
- Если есть один wal, то его можно удалить, так как checkpoint не мог быть начат
- Если есть два wal'а, то новый удаляем, а для старого проверяем меньше или равен его оффсет комита барсика. Если да, то делаем checkpoint, если нет,
то также удаляем его
