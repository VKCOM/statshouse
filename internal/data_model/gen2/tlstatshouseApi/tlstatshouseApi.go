// Copyright 2023 V Kontakte LLC
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

// Code generated by vktl/cmd/tlgen2; DO NOT EDIT.
package tlstatshouseApi

import (
	"context"

	"github.com/vkcom/statshouse/internal/data_model/gen2/internal"
	"github.com/vkcom/statshouse/internal/vkgo/basictl"
	"github.com/vkcom/statshouse/internal/vkgo/rpc"
)

type (
	Filter                = internal.StatshouseApiFilter
	Flag                  = internal.StatshouseApiFlag
	Function              = internal.StatshouseApiFunction
	GetChunk              = internal.StatshouseApiGetChunk
	GetChunkResponse      = internal.StatshouseApiGetChunkResponse
	GetQuery              = internal.StatshouseApiGetQuery
	GetQueryResponse      = internal.StatshouseApiGetQueryResponse
	Query                 = internal.StatshouseApiQuery
	ReleaseChunks         = internal.StatshouseApiReleaseChunks
	ReleaseChunksResponse = internal.StatshouseApiReleaseChunksResponse
	Series                = internal.StatshouseApiSeries
	SeriesMeta            = internal.StatshouseApiSeriesMeta
	TagValue              = internal.StatshouseApiTagValue
)

func FlagAuto() Flag                   { return internal.StatshouseApiFlagAuto() }
func FlagMapped() Flag                 { return internal.StatshouseApiFlagMapped() }
func FlagRaw() Flag                    { return internal.StatshouseApiFlagRaw() }
func FnAvg() Function                  { return internal.StatshouseApiFnAvg() }
func FnCount() Function                { return internal.StatshouseApiFnCount() }
func FnCountNorm() Function            { return internal.StatshouseApiFnCountNorm() }
func FnCumulAvg() Function             { return internal.StatshouseApiFnCumulAvg() }
func FnCumulCount() Function           { return internal.StatshouseApiFnCumulCount() }
func FnCumulSum() Function             { return internal.StatshouseApiFnCumulSum() }
func FnDerivativeAvg() Function        { return internal.StatshouseApiFnDerivativeAvg() }
func FnDerivativeCount() Function      { return internal.StatshouseApiFnDerivativeCount() }
func FnDerivativeCountNorm() Function  { return internal.StatshouseApiFnDerivativeCountNorm() }
func FnDerivativeMax() Function        { return internal.StatshouseApiFnDerivativeMax() }
func FnDerivativeMin() Function        { return internal.StatshouseApiFnDerivativeMin() }
func FnDerivativeSum() Function        { return internal.StatshouseApiFnDerivativeSum() }
func FnDerivativeSumNorm() Function    { return internal.StatshouseApiFnDerivativeSumNorm() }
func FnDerivativeUnique() Function     { return internal.StatshouseApiFnDerivativeUnique() }
func FnDerivativeUniqueNorm() Function { return internal.StatshouseApiFnDerivativeUniqueNorm() }
func FnMax() Function                  { return internal.StatshouseApiFnMax() }
func FnMaxCountHost() Function         { return internal.StatshouseApiFnMaxCountHost() }
func FnMaxHost() Function              { return internal.StatshouseApiFnMaxHost() }
func FnMin() Function                  { return internal.StatshouseApiFnMin() }
func FnP25() Function                  { return internal.StatshouseApiFnP25() }
func FnP50() Function                  { return internal.StatshouseApiFnP50() }
func FnP75() Function                  { return internal.StatshouseApiFnP75() }
func FnP90() Function                  { return internal.StatshouseApiFnP90() }
func FnP95() Function                  { return internal.StatshouseApiFnP95() }
func FnP99() Function                  { return internal.StatshouseApiFnP99() }
func FnP999() Function                 { return internal.StatshouseApiFnP999() }
func FnStddev() Function               { return internal.StatshouseApiFnStddev() }
func FnSum() Function                  { return internal.StatshouseApiFnSum() }
func FnSumNorm() Function              { return internal.StatshouseApiFnSumNorm() }
func FnUnique() Function               { return internal.StatshouseApiFnUnique() }
func FnUniqueNorm() Function           { return internal.StatshouseApiFnUniqueNorm() }

type Client struct {
	Client  *rpc.Client
	Network string // should be either "tcp4" or "unix"
	Address string
	ActorID uint64 // should be non-zero when using rpc-proxy
}

func (c *Client) GetChunk(ctx context.Context, args GetChunk, extra *rpc.InvokeReqExtra, ret *GetChunkResponse) (err error) {
	req := c.Client.GetRequest()
	req.ActorID = c.ActorID
	if extra != nil {
		req.Extra = *extra
	}
	req.Body, err = args.WriteBoxed(req.Body)
	if err != nil {
		return internal.ErrorClientWrite("statshouseApi.getChunk", err)
	}
	resp, err := c.Client.Do(ctx, c.Network, c.Address, req)
	if err != nil {
		return internal.ErrorClientDo("statshouseApi.getChunk", c.Network, c.ActorID, c.Address, err)
	}
	defer c.Client.PutResponse(resp)
	if ret != nil {
		if _, err = args.ReadResult(resp.Body, ret); err != nil {
			return internal.ErrorClientReadResult("statshouseApi.getChunk", c.Network, c.ActorID, c.Address, err)
		}
	}
	return nil
}

func (c *Client) GetQuery(ctx context.Context, args GetQuery, extra *rpc.InvokeReqExtra, ret *GetQueryResponse) (err error) {
	req := c.Client.GetRequest()
	req.ActorID = c.ActorID
	if extra != nil {
		req.Extra = *extra
	}
	req.Body, err = args.WriteBoxed(req.Body)
	if err != nil {
		return internal.ErrorClientWrite("statshouseApi.getQuery", err)
	}
	resp, err := c.Client.Do(ctx, c.Network, c.Address, req)
	if err != nil {
		return internal.ErrorClientDo("statshouseApi.getQuery", c.Network, c.ActorID, c.Address, err)
	}
	defer c.Client.PutResponse(resp)
	if ret != nil {
		if _, err = args.ReadResult(resp.Body, ret); err != nil {
			return internal.ErrorClientReadResult("statshouseApi.getQuery", c.Network, c.ActorID, c.Address, err)
		}
	}
	return nil
}

func (c *Client) ReleaseChunks(ctx context.Context, args ReleaseChunks, extra *rpc.InvokeReqExtra, ret *ReleaseChunksResponse) (err error) {
	req := c.Client.GetRequest()
	req.ActorID = c.ActorID
	if extra != nil {
		req.Extra = *extra
	}
	req.Body, err = args.WriteBoxed(req.Body)
	if err != nil {
		return internal.ErrorClientWrite("statshouseApi.releaseChunks", err)
	}
	resp, err := c.Client.Do(ctx, c.Network, c.Address, req)
	if err != nil {
		return internal.ErrorClientDo("statshouseApi.releaseChunks", c.Network, c.ActorID, c.Address, err)
	}
	defer c.Client.PutResponse(resp)
	if ret != nil {
		if _, err = args.ReadResult(resp.Body, ret); err != nil {
			return internal.ErrorClientReadResult("statshouseApi.releaseChunks", c.Network, c.ActorID, c.Address, err)
		}
	}
	return nil
}

type Handler struct {
	GetChunk      func(ctx context.Context, args GetChunk) (GetChunkResponse, error)           // statshouseApi.getChunk
	GetQuery      func(ctx context.Context, args GetQuery) (GetQueryResponse, error)           // statshouseApi.getQuery
	ReleaseChunks func(ctx context.Context, args ReleaseChunks) (ReleaseChunksResponse, error) // statshouseApi.releaseChunks

	RawGetChunk      func(ctx context.Context, hctx *rpc.HandlerContext) error // statshouseApi.getChunk
	RawGetQuery      func(ctx context.Context, hctx *rpc.HandlerContext) error // statshouseApi.getQuery
	RawReleaseChunks func(ctx context.Context, hctx *rpc.HandlerContext) error // statshouseApi.releaseChunks
}

func (h *Handler) Handle(ctx context.Context, hctx *rpc.HandlerContext) (err error) {
	tag, r, _ := basictl.NatReadTag(hctx.Request) // keep hctx.Request intact for handler chaining
	switch tag {
	case 0x52721884: // statshouseApi.getChunk
		if h.RawGetChunk != nil {
			hctx.Request = r
			err = h.RawGetChunk(ctx, hctx)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.getChunk", err)
			}
			return nil
		}
		if h.GetChunk != nil {
			var args GetChunk
			if _, err = args.Read(r); err != nil {
				return internal.ErrorServerRead("statshouseApi.getChunk", err)
			}
			ctx = hctx.WithContext(ctx)
			ret, err := h.GetChunk(ctx, args)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.getChunk", err)
			}
			if hctx.Response, err = args.WriteResult(hctx.Response, ret); err != nil {
				return internal.ErrorServerWriteResult("statshouseApi.getChunk", err)
			}
			return nil
		}
	case 0x0c7349bb: // statshouseApi.getQuery
		if h.RawGetQuery != nil {
			hctx.Request = r
			err = h.RawGetQuery(ctx, hctx)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.getQuery", err)
			}
			return nil
		}
		if h.GetQuery != nil {
			var args GetQuery
			if _, err = args.Read(r); err != nil {
				return internal.ErrorServerRead("statshouseApi.getQuery", err)
			}
			ctx = hctx.WithContext(ctx)
			ret, err := h.GetQuery(ctx, args)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.getQuery", err)
			}
			if hctx.Response, err = args.WriteResult(hctx.Response, ret); err != nil {
				return internal.ErrorServerWriteResult("statshouseApi.getQuery", err)
			}
			return nil
		}
	case 0x62adc773: // statshouseApi.releaseChunks
		if h.RawReleaseChunks != nil {
			hctx.Request = r
			err = h.RawReleaseChunks(ctx, hctx)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.releaseChunks", err)
			}
			return nil
		}
		if h.ReleaseChunks != nil {
			var args ReleaseChunks
			if _, err = args.Read(r); err != nil {
				return internal.ErrorServerRead("statshouseApi.releaseChunks", err)
			}
			ctx = hctx.WithContext(ctx)
			ret, err := h.ReleaseChunks(ctx, args)
			if rpc.IsHijackedResponse(err) {
				return err
			}
			if err != nil {
				return internal.ErrorServerHandle("statshouseApi.releaseChunks", err)
			}
			if hctx.Response, err = args.WriteResult(hctx.Response, ret); err != nil {
				return internal.ErrorServerWriteResult("statshouseApi.releaseChunks", err)
			}
			return nil
		}
	}
	return rpc.ErrNoHandler
}
